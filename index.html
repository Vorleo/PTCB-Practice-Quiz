<!doctype html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PTCB Practice Exam (2026 Weighted • 90 Questions)</title>
  <meta name="description" content="PTCB/PTCE-style practice exam: 90 questions, 4 options, timer, dark/light mode, realistic workflows, conversions, DEA forms, USP chapters, optional RxNav dynamic meds." />

  <style>
    /* ========= Theme tokens ========= */
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted: #4b5563;
      --border: #e5e7eb;
      --shadow: 0 6px 20px rgba(0,0,0,.06);

      --header-bg: #111827;
      --header-text: #ffffff;

      --pill-bg: #f3f4f6;
      --pill-text: #111827;

      --primary: #111827;
      --primary-text: #ffffff;

      --secondary: #e5e7eb;
      --secondary-text: #111827;

      --danger: #b91c1c;
      --danger-text: #ffffff;

      --accent: #2563eb;

      --tag-bg: #eef2ff;
      --tag-text: #1e3a8a;

      --ok-bg: #ecfdf5;
      --ok-border: #a7f3d0;
      --ok-text: #065f46;

      --note-bg: #fefce8;
      --note-border: #fde68a;
      --note-text: #713f12;

      --warn-bg: #fff7ed;
      --warn-border: #fed7aa;
      --warn-text: #9a3412;

      --choice-hover: #f9fafb;
      --choice-selected: #eff6ff;
    }

    html[data-theme="dark"]{
      --bg: #0b1020;
      --card: #0f172a;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #243047;
      --shadow: 0 10px 28px rgba(0,0,0,.45);

      --header-bg: #0a0f1e;
      --header-text: #e5e7eb;

      --pill-bg: #111b33;
      --pill-text: #e5e7eb;

      --primary: #2563eb;
      --primary-text: #ffffff;

      --secondary: #1f2a44;
      --secondary-text: #e5e7eb;

      --danger: #ef4444;
      --danger-text: #111827;

      --accent: #60a5fa;

      --tag-bg: #111b33;
      --tag-text: #bfdbfe;

      --ok-bg: #06291f;
      --ok-border: #0f4d3a;
      --ok-text: #86efac;

      --note-bg: #2b2206;
      --note-border: #6b4f00;
      --note-text: #fde68a;

      --warn-bg: #2b1508;
      --warn-border: #7c2d12;
      --warn-text: #fdba74;

      --choice-hover: #111b33;
      --choice-selected: #0b2a55;
    }

    /* ========= Base ========= */
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--text); }
    body { margin: 0; background: var(--bg); }

    header { background: var(--header-bg); color: var(--header-text); padding: 16px 18px; }
    header h1 { margin: 0; font-size: 18px; }
    header p { margin: 6px 0 0; font-size: 13px; opacity: .92; }

    .headerRow{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      max-width: 980px; margin: 0 auto;
    }
    .themeControls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

    .wrap { max-width: 980px; margin: 18px auto; padding: 0 14px; }
    .card { background: var(--card); border-radius: 14px; box-shadow: var(--shadow); padding: 16px; border: 1px solid rgba(0,0,0,0); }
    html[data-theme="dark"] .card { border-color: var(--border); }

    .grid { display: grid; grid-template-columns: 1.2fr .8fr; gap: 14px; align-items: start; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .muted { color: var(--muted); }
    .tiny { font-size: 12px; }

    .pill { display:inline-flex; gap:8px; align-items:center; padding: 6px 10px; background: var(--pill-bg); color: var(--pill-text); border-radius: 999px; font-size: 12px; border: 1px solid var(--border); }
    .pill b { font-weight: 800; }

    .progress { height: 10px; background: var(--border); border-radius:999px; overflow:hidden; }
    .bar { height: 100%; background: var(--accent); width:0%; transition: width .2s ease; }

    button {
      border: 0; border-radius: 10px; padding: 10px 12px; cursor: pointer;
      background: var(--primary); color: var(--primary-text); font-weight: 800;
    }
    button.secondary { background: var(--secondary); color: var(--secondary-text); }
    button.warn { background: var(--danger); color: var(--danger-text); }
    button:disabled { opacity:.5; cursor:not-allowed; }

    select{
      border:1px solid var(--border);
      background: var(--card);
      color: var(--text);
      border-radius: 10px;
      padding: 9px 10px;
      font-weight: 800;
    }

    .qhead { display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .qtitle { font-size: 16px; margin: 0 0 6px; }
    .domainTag { font-size: 12px; padding: 5px 10px; border-radius: 999px; background: var(--tag-bg); color: var(--tag-text); white-space: nowrap; border: 1px solid var(--border); }
    .stem { margin: 8px 0 12px; line-height: 1.35; }
    .choices { display:grid; gap: 10px; }

    label.choice {
      display:flex; gap:10px; align-items:flex-start;
      padding: 12px; border: 1px solid var(--border); border-radius: 12px; cursor:pointer;
      transition: background .12s ease, border-color .12s ease;
      background: rgba(0,0,0,0);
    }
    label.choice:hover { background: var(--choice-hover); }
    label.choice.selected { background: var(--choice-selected); border-color: var(--accent); }
    input[type="radio"] { margin-top: 3px; }

    .rightPane .card { position: sticky; top: 14px; }
    .navgrid { display:grid; grid-template-columns: repeat(10, 1fr); gap: 6px; margin-top: 10px; }
    .navbtn {
      width: 100%; padding: 8px 0; border-radius: 10px; border: 1px solid var(--border);
      background: var(--card); color: var(--text); font-weight:800; cursor:pointer; font-size: 12px;
    }
    .navbtn.answered { background: rgba(16,185,129,.18); border-color: rgba(16,185,129,.35); }
    .navbtn.flagged { background: rgba(245,158,11,.18); border-color: rgba(245,158,11,.35); }
    .navbtn.current { outline: 2px solid var(--accent); border-color: var(--accent); }

    .hr { height:1px; background: var(--border); margin: 12px 0; }
    .reviewItem { border:1px solid var(--border); border-radius: 12px; padding: 12px; margin-bottom: 10px; }
    .correct { color:#10b981; font-weight: 900; }
    .incorrect { color:#ef4444; font-weight: 900; }
    .explain { background: rgba(127,127,127,.10); border-radius: 10px; padding: 10px; margin-top: 8px; color: var(--text); border: 1px solid var(--border); }

    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; background: var(--primary); color: var(--primary-text); padding: 3px 6px; border-radius: 6px; }
    .note { background: var(--note-bg); border: 1px solid var(--note-border); color: var(--note-text); padding: 10px 12px; border-radius: 12px; }
    .ok { background: var(--ok-bg); border:1px solid var(--ok-border); color: var(--ok-text); padding: 10px 12px; border-radius: 12px; }
    .warnbox { background: var(--warn-bg); border:1px solid var(--warn-border); color: var(--warn-text); padding: 10px 12px; border-radius: 12px; }

    @media (max-width: 900px){
      .grid { grid-template-columns: 1fr; }
      .rightPane .card { position: static; }
      .headerRow{ flex-direction:column; align-items:flex-start; }
      .themeControls{ justify-content:flex-start; }
    }
    @media (max-width: 520px){
      header { padding: 14px 14px; }
      .wrap { padding: 0 10px; }
      .navgrid { grid-template-columns: repeat(8, 1fr); }
      button { padding: 12px 12px; }
      label.choice { padding: 14px; }
      .pill { font-size: 11px; }
    }
  </style>
</head>

<body>
<header>
  <div class="headerRow">
    <div>
      <h1>PTCB Practice Exam — 2026 Weighting • 90 Questions</h1>
      <p>90 questions • 4 options • Submit anytime • Optional timer • Dark/Light mode • DEA/USP/Math/Workflow • Optional RxNav meds</p>
    </div>

    <div class="themeControls">
      <span class="pill">Theme</span>
      <button id="themeAutoBtn" class="secondary" title="Follow device theme">Auto</button>
      <button id="themeLightBtn" class="secondary">Light</button>
      <button id="themeDarkBtn" class="secondary">Dark</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div id="startScreen" class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <h2 style="margin:0 0 6px">Start</h2>
        <div class="muted tiny">
          Built for 2026-style weighting mapped to 90 questions:
          <b>32 Medications</b>, <b>21 Safety</b>, <b>20 Order Entry</b>, <b>17 Federal</b>.
        </div>
      </div>
      <div class="pill"><b>90</b> questions • <b>4</b> options</div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <label class="pill" style="cursor:pointer"><input id="shuffleQ" type="checkbox" checked /> Shuffle questions</label>
      <label class="pill" style="cursor:pointer"><input id="shuffleA" type="checkbox" checked /> Shuffle answer choices</label>

      <label class="pill" style="cursor:pointer"><input id="timed" type="checkbox" /> Timed</label>
      <label class="pill" style="cursor:pointer">
        Timer length
        <select id="timerLen">
          <option value="110" selected>110 min (PTCE)</option>
          <option value="90">90 min</option>
          <option value="120">120 min</option>
        </select>
      </label>

      <label class="pill" style="cursor:pointer"><input id="useOnlineMeds" type="checkbox" checked /> Use online meds (RxNav)</label>
    </div>

    <div class="hr"></div>

    <div class="note tiny">
      You can <b>submit anytime</b> after the exam finishes building — unanswered questions stay <b>unanswered</b>.
      Keyboard: <span class="kbd">←</span>/<span class="kbd">→</span> prev/next.
    </div>

    <div id="statusBox" class="ok tiny" style="margin-top:12px; display:none;"></div>

    <div class="row" style="margin-top:12px">
      <button id="startBtn">Start Exam</button>
      <button id="resetBtn" class="secondary">Reset</button>
    </div>

    <div class="hr"></div>
    <div class="muted tiny">
      This is a study simulator (not official PTCB questions). If RxNav is enabled, some brand/generic questions are generated dynamically using RxNorm/RxNav.
    </div>
  </div>

  <div id="examScreen" style="display:none" class="grid">
    <div class="leftPane">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <span class="pill">Q <b id="qCounter">1</b>/90</span>
            <span class="pill">Answered: <b id="answeredCount">0</b></span>
            <span class="pill">Flagged: <b id="flagCount">0</b></span>
          </div>
          <div class="row">
            <span id="timerPill" class="pill" style="display:none">Time left: <b id="timeLeft">110:00</b></span>
            <button id="submitBtn" class="warn" disabled>Submit</button>
          </div>
        </div>

        <div style="margin:12px 0">
          <div class="progress"><div id="progressBar" class="bar"></div></div>
          <div class="tiny muted" style="margin-top:6px">Progress tracks how many you answered.</div>
        </div>

        <div class="hr"></div>

        <div class="qhead">
          <div>
            <h3 id="qTitle" class="qtitle">Question</h3>
            <div id="qMeta" class="tiny muted"></div>
          </div>
          <div id="domainTag" class="domainTag">Domain</div>
        </div>

        <div id="qStem" class="stem"></div>
        <div id="choices" class="choices"></div>

        <div class="hr"></div>

        <div class="row" style="justify-content:space-between">
          <div class="row">
            <button id="prevBtn" class="secondary">← Prev</button>
            <button id="nextBtn">Next →</button>
          </div>
          <div class="row">
            <button id="flagBtn" class="secondary">Flag</button>
            <button id="clearBtn" class="secondary">Clear Answer</button>
          </div>
        </div>
      </div>
    </div>

    <div class="rightPane">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">Navigator</h3>
          <button id="endBtn" class="secondary">Exit</button>
        </div>
        <div class="tiny muted" style="margin-top:6px">
          Green = answered • Orange = flagged • Blue outline = current
        </div>
        <div id="navGrid" class="navgrid"></div>
      </div>
    </div>
  </div>

  <div id="resultsScreen" style="display:none" class="card">
    <div class="row" style="justify-content:space-between; align-items:flex-start">
      <div>
        <h2 style="margin:0 0 6px">Results</h2>
        <div class="muted tiny">Practice scoring + review. (Not official.)</div>
      </div>
      <div class="row">
        <button id="restartBtn">Restart</button>
        <button id="backHomeBtn" class="secondary">Home</button>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <div class="pill">Overall: <b id="overallScore">0%</b></div>
      <div class="pill">Correct: <b id="correctCount">0</b></div>
      <div class="pill">Incorrect: <b id="incorrectCount">0</b></div>
      <div class="pill">Unanswered: <b id="unansweredCount">0</b></div>
    </div>

    <div class="hr"></div>

    <h3 style="margin:0 0 8px">Domain Breakdown</h3>
    <div id="domainBreakdown" class="row" style="gap:8px"></div>

    <div class="hr"></div>

    <h3 style="margin:0 0 8px">Review</h3>
    <div id="reviewList"></div>
  </div>
</div>

<script>
/* =========================
   Theme (Auto/Light/Dark)
========================= */
const THEME_KEY = "ptcb_theme_pref_v2";
function applyTheme(mode){
  const html = document.documentElement;
  if(mode === "auto"){
    const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    html.setAttribute("data-theme", prefersDark ? "dark" : "light");
    localStorage.setItem(THEME_KEY, "auto");
    return;
  }
  html.setAttribute("data-theme", mode);
  localStorage.setItem(THEME_KEY, mode);
}
function loadTheme(){
  const saved = localStorage.getItem(THEME_KEY) || "auto";
  if(saved === "auto") applyTheme("auto"); else applyTheme(saved);
}
document.getElementById("themeAutoBtn").addEventListener("click", ()=>applyTheme("auto"));
document.getElementById("themeLightBtn").addEventListener("click", ()=>applyTheme("light"));
document.getElementById("themeDarkBtn").addEventListener("click", ()=>applyTheme("dark"));
loadTheme();

/* =========================
   Core configuration
========================= */
const TOTAL_QUESTIONS = 90;

// 2026-weight mapping to 90 questions (integer allocation):
// Meds 32, Safety 21, Order 20, Federal 17
const DOMAIN = {
  MEDS: "Medications",
  SAFETY: "Patient Safety & Quality Assurance",
  ORDER: "Order Entry & Processing",
  FED: "Federal Requirements"
};
const COUNTS = {
  [DOMAIN.MEDS]: 32,
  [DOMAIN.SAFETY]: 21,
  [DOMAIN.ORDER]: 20,
  [DOMAIN.FED]: 17
};

function shuffle(arr){
  for (let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function fmtTime(sec){
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return `${m}:${String(s).padStart(2,'0')}`;
}

/* =========================
   RxNav dynamic meds (optional)
========================= */
const RXNAV_BASE = "https://rxnav.nlm.nih.gov/REST";
const MED_SEEDS = [
  "lisinopril","losartan","valsartan","olmesartan","enalapril","benazepril","ramipril",
  "amlodipine","diltiazem","verapamil",
  "metoprolol","carvedilol","atenolol","propranolol",
  "hydrochlorothiazide","chlorthalidone","furosemide","spironolactone",
  "atorvastatin","rosuvastatin","simvastatin","pravastatin",
  "metformin","glipizide","glyburide","sitagliptin","empagliflozin",
  "insulin glargine","insulin lispro","insulin aspart",
  "levothyroxine",
  "omeprazole","pantoprazole","esomeprazole","lansoprazole",
  "sertraline","fluoxetine","citalopram","escitalopram","paroxetine",
  "duloxetine","venlafaxine","bupropion",
  "gabapentin","pregabalin",
  "amoxicillin","amoxicillin clavulanate","cephalexin","doxycycline","clindamycin","azithromycin",
  "sulfamethoxazole trimethoprim",
  "warfarin","apixaban","rivaroxaban","clopidogrel","aspirin",
  "albuterol","fluticasone","budesonide","montelukast",
  "tamsulosin","finasteride",
  "ondansetron","promethazine",
  "ibuprofen","naproxen","meloxicam",
  "tramadol","hydrocodone acetaminophen",
  "famotidine","cetirizine","loratadine",
  "sildenafil","tadalafil",
  "allopurinol","colchicine",
  "prednisone","valacyclovir","acyclovir","oseltamivir"
];

function withTimeout(promiseFactory, ms){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), ms);
  return { promise: promiseFactory(ctrl.signal).finally(()=>clearTimeout(t)), ctrl };
}
async function fetchJson(url, signal){
  const res = await fetch(url, { signal });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}
function extractBrandsFromDrugName(rxName){
  const matches = rxName.match(/\[([^\]]+)\]/g) || [];
  return matches.map(m => m.replace(/^\[/,'').replace(/\]$/,'').trim()).filter(Boolean);
}
async function rxnavBrandsForIngredient(ingredient, signal){
  const url = `${RXNAV_BASE}/drugs.json?name=${encodeURIComponent(ingredient)}`;
  const data = await fetchJson(url, signal);
  const groups = (data?.drugGroup?.conceptGroup) || [];
  const sbd = groups.find(g => g.tty === "SBD");
  const concepts = sbd?.conceptProperties || [];
  const brands = new Set();
  for(const c of concepts){
    const name = c?.name || "";
    for(const b of extractBrandsFromDrugName(name)) brands.add(b);
  }
  const bnGroup = groups.find(g => g.tty === "BN");
  const bnConcepts = bnGroup?.conceptProperties || [];
  for(const c of bnConcepts){
    if(c?.name) brands.add(c.name.trim());
  }
  return Array.from(brands);
}
function makeChoices(correct, distractors){
  const wrongs = shuffle(distractors.filter(x => x && x.toLowerCase() !== correct.toLowerCase()));
  const picked = [];
  for(const w of wrongs){
    if(picked.length >= 3) break;
    if(!picked.some(p => p.toLowerCase() === w.toLowerCase())) picked.push(w);
  }
  if(picked.length < 3) return null;
  const choices = shuffle([correct, ...picked]);
  return { choices, answerIndex: choices.indexOf(correct) };
}
async function buildDynamicMedsQuestions(targetCount){
  // Keep dynamic as a subset to reduce duplicates & keep variety from local bank.
  const desired = Math.min(targetCount, 20);
  const seeds = shuffle(MED_SEEDS.slice()).slice(0, 24);

  const ingredientToBrands = new Map();
  const concurrency = 5;
  let i = 0;

  async function worker(){
    while (i < seeds.length){
      const ing = seeds[i++];
      try{
        const { promise } = withTimeout((signal)=>rxnavBrandsForIngredient(ing, signal), 6500);
        const brands = await promise;
        if (brands && brands.length >= 1) ingredientToBrands.set(ing, brands.slice(0, 14));
      } catch(e){ /* ignore */ }
    }
  }
  await Promise.all(Array.from({length: concurrency}, worker));

  const allBrands = [];
  ingredientToBrands.forEach(brands => brands.forEach(b => allBrands.push(b)));
  const uniqBrands = Array.from(new Set(allBrands));
  shuffle(uniqBrands);

  const qs = [];
  for(const [ing, brands] of ingredientToBrands.entries()){
    if(qs.length >= desired) break;

    const brand = brands[Math.floor(Math.random() * brands.length)];
    const c1 = makeChoices(brand, uniqBrands);
    if(c1){
      qs.push({
        id: `rxnav:gen2brand:${ing.toLowerCase()}:${brand.toLowerCase()}`,
        domain: DOMAIN.MEDS,
        stem: `Which brand name corresponds to the generic medication <b>${ing}</b>?`,
        choices: c1.choices,
        answerIndex: c1.answerIndex,
        explanation: `Generated from RxNav/RxNorm (dynamic).`,
        ref: "RxNav/RxNorm (dynamic)"
      });
    }
    if(qs.length >= desired) break;

    if(Math.random() < 0.7){
      const distractorGens = shuffle(MED_SEEDS.filter(x => x.toLowerCase() !== ing.toLowerCase())).slice(0, 18);
      const c2 = makeChoices(ing, distractorGens);
      if(c2){
        qs.push({
          id: `rxnav:brand2gen:${brand.toLowerCase()}:${ing.toLowerCase()}`,
          domain: DOMAIN.MEDS,
          stem: `Which generic medication corresponds to the brand name <b>${brand}</b>?`,
          choices: c2.choices,
          answerIndex: c2.answerIndex,
          explanation: `Generated from RxNav/RxNorm (dynamic).`,
          ref: "RxNav/RxNorm (dynamic)"
        });
      }
    }
  }
  return qs.slice(0, targetCount);
}

/* =========================
   Local question bank (expanded)
========================= */
function buildLocalBank(){
  const bank = [];
  const add = (domain, stem, correct, wrong, explanation, ref, id) => {
    const choices = shuffle([correct, ...wrong]);
    bank.push({
      id,
      domain,
      stem,
      choices,
      answerIndex: choices.indexOf(correct),
      explanation,
      ref
    });
  };

  let n = 1;

  // ---------- MEDICATIONS ----------
  const M = DOMAIN.MEDS;

  const gbPairs = [
    ["atorvastatin","Lipitor"],["rosuvastatin","Crestor"],["simvastatin","Zocor"],["pravastatin","Pravachol"],
    ["lisinopril","Prinivil/Zestril"],["losartan","Cozaar"],["valsartan","Diovan"],["amlodipine","Norvasc"],
    ["metformin","Glucophage"],["glipizide","Glucotrol"],["glyburide","DiaBeta"],["sitagliptin","Januvia"],
    ["levothyroxine","Synthroid"],["omeprazole","Prilosec"],["pantoprazole","Protonix"],
    ["sertraline","Zoloft"],["fluoxetine","Prozac"],["escitalopram","Lexapro"],
    ["bupropion","Wellbutrin"],["duloxetine","Cymbalta"],["venlafaxine","Effexor XR"],
    ["gabapentin","Neurontin"],["pregabalin","Lyrica"],
    ["albuterol","Ventolin/ProAir"],["fluticasone (nasal)","Flonase"],["montelukast","Singulair"],
    ["tamsulosin","Flomax"],["finasteride","Proscar"],
    ["ondansetron","Zofran"],["famotidine","Pepcid"],
    ["cetirizine","Zyrtec"],["loratadine","Claritin"],
    ["valacyclovir","Valtrex"],["acyclovir","Zovirax"],
    ["clopidogrel","Plavix"],["furosemide","Lasix"]
  ];
  for(const [g,b] of gbPairs){
    add(M, `Brand name for <b>${g}</b>:`, b,
      ["Zoloft","Lasix","Protonix"].filter(x=>x!==b).slice(0,3),
      `Common association: ${g} is known by brand ${b}.`, "Generic/Brand", `local:meds:gb:${n++}`);
  }

  add(M, "Which suffix suggests an <b>ACE inhibitor</b>?", "-pril",
    ["-sartan","-olol","-statin"], "ACE inhibitors commonly end in -pril.", "Suffixes", `local:meds:suf:${n++}`);
  add(M, "Which suffix suggests an <b>ARB</b>?", "-sartan",
    ["-pril","-prazole","-olol"], "ARBs commonly end in -sartan.", "Suffixes", `local:meds:suf:${n++}`);
  add(M, "Which suffix suggests a <b>beta blocker</b>?", "-olol",
    ["-pril","-prazole","-statin"], "Many beta blockers end in -olol.", "Suffixes", `local:meds:suf:${n++}`);
  add(M, "Which suffix suggests a <b>statin</b>?", "-statin",
    ["-mab","-azole","-caine"], "Statins end in -statin.", "Suffixes", `local:meds:suf:${n++}`);
  add(M, "Which suffix suggests a <b>PPI</b>?", "-prazole",
    ["-pril","-sartan","-cycline"], "PPIs often end in -prazole.", "Suffixes", `local:meds:suf:${n++}`);

  add(M, "Which medication is commonly used for <b>acute asthma relief</b>?", "Albuterol",
    ["Fluticasone","Montelukast","Cetirizine"], "Albuterol is a short-acting beta agonist for quick relief.", "Indications", `local:meds:ind:${n++}`);
  add(M, "Which is typically a <b>rapid-acting insulin</b>?", "Insulin lispro",
    ["Insulin glargine","NPH insulin","Insulin detemir"], "Lispro/aspart are rapid; glargine/detemir long; NPH intermediate.", "Insulin types", `local:meds:ins:${n++}`);
  add(M, "A common adverse effect of <b>ACE inhibitors</b> is:", "Dry cough",
    ["Constipation","Hair loss","Tooth discoloration"], "ACE inhibitors can cause a dry cough.", "Side effects", `local:meds:se:${n++}`);
  add(M, "Warfarin + which OTC most increases bleeding risk?", "NSAIDs (ibuprofen/naproxen)",
    ["Calcium carbonate","Saline nasal spray","Artificial tears"], "NSAIDs increase bleeding risk with anticoagulants.", "Interactions", `local:meds:int:${n++}`);
  add(M, "Nitrates + sildenafil can cause:", "Severe hypotension",
    ["Hyperglycemia","QT shortening","Kidney stones"], "PDE-5 inhibitors + nitrates can dangerously lower blood pressure.", "Interactions", `local:meds:int:${n++}`);
  add(M, "A common indication for <b>tamsulosin</b> is:", "BPH urinary symptoms",
    ["Hyperthyroidism","Bacterial pneumonia","Gout flare"], "Tamsulosin is an alpha-1 blocker used for BPH symptoms.", "Indications", `local:meds:ind:${n++}`);
  add(M, "Which antibiotic is a <b>macrolide</b>?", "Azithromycin",
    ["Cephalexin","Doxycycline","Amoxicillin"], "Azithromycin is a macrolide.", "Classes", `local:meds:cls:${n++}`);
  add(M, "Which is a <b>tetracycline</b> antibiotic?", "Doxycycline",
    ["Clindamycin","Cephalexin","Azithromycin"], "Doxycycline is a tetracycline.", "Classes", `local:meds:cls:${n++}`);
  add(M, "Which medication is commonly used for <b>GERD</b>?", "Omeprazole",
    ["Albuterol","Acyclovir","Tamsulosin"], "PPIs are commonly used for GERD.", "Indications", `local:meds:ind:${n++}`);
  add(M, "Therapeutic duplication means:", "Two meds with same effect used together unnecessarily",
    ["Two pharmacies fill one Rx","Two NDCs in a bin","Two refills on a label"], "Duplication increases risk without benefit.", "Safety concept", `local:meds:dup:${n++}`);

  // ---------- SAFETY / QUALITY / USP / STERILE / ERROR PREVENTION ----------
  const S = DOMAIN.SAFETY;

  add(S, "USP <795> covers:", "Non-sterile compounding",
    ["Sterile compounding","Controlled substance ordering","Insurance billing"],
    "USP 795: non-sterile compounding standards.", "USP", `local:safety:usp:${n++}`);
  add(S, "USP <797> covers:", "Sterile compounding",
    ["Non-sterile compounding","Look-alike/sound-alike policies","DEA ordering"],
    "USP 797: sterile compounding standards.", "USP", `local:safety:usp:${n++}`);
  add(S, "USP <800> focuses on:", "Hazardous drug handling safety",
    ["Sterile technique only","DSCSA only","PBM claims"],
    "USP 800: handling hazardous drugs to reduce exposure.", "USP", `local:safety:usp:${n++}`);

  add(S, "Sterile compounding: best garbing order (simplified):", "Hand hygiene → gown → mask → gloves",
    ["Gloves → gown → mask → hands","Mask → gloves → gown → hands","Gown → gloves → hands → mask"],
    "Hand hygiene first; then don garb to reduce contamination risk.", "Sterile technique", `local:safety:garb:${n++}`);

  add(S, "Best practice for a <b>leading zero</b> is:", "Write 0.5 mg (not .5 mg)",
    ["Write .5 mg only","Write 00.5 mg","Never use decimals"],
    "Leading zeros reduce tenfold errors.", "Error prevention", `local:safety:err:${n++}`);
  add(S, "Best practice for a <b>trailing zero</b> is:", "Avoid 5.0 mg; write 5 mg",
    ["Always write 5.0 mg","Write 5.00 mg","Use commas instead"],
    "Trailing zeros can cause tenfold errors.", "Error prevention", `local:safety:err:${n++}`);
  add(S, "LASA stands for:", "Look-alike/sound-alike",
    ["Long-acting/short-acting","Lot-and-serial-audit","Label-all/store-all"],
    "LASA meds are a common source of dispensing errors.", "Terminology", `local:safety:lasa:${n++}`);
  add(S, "A high-alert medication example is:", "Insulin",
    ["Acetaminophen","Docusate","Loratadine"],
    "Insulin is commonly classified high-alert due to harm potential.", "High-alert", `local:safety:ha:${n++}`);

  add(S, "What should a tech do if a prescription has a potentially dangerous dose?", "Refer to the pharmacist for clinical review",
    ["Change the dose in the system","Fill as written without question","Call insurance first"],
    "Clinical assessment/intervention is pharmacist responsibility.", "Scope/Workflow", `local:safety:scope:${n++}`);

  add(S, "MedWatch is used to report:", "Serious adverse events/product quality issues to the FDA",
    ["Theft/loss to the DEA","HIPAA violations to OCR","Insurance fraud to PBM"],
    "MedWatch is FDA’s safety reporting program.", "Reporting", `local:safety:report:${n++}`);

  // ---------- ORDER ENTRY / PROCESSING / MATH / INSURANCE / COMPOUNDING ----------
  const O = DOMAIN.ORDER;

  // Conversions
  add(O, "How many <b>mcg</b> are in <b>1 mg</b>?", "1000 mcg",
    ["100 mcg","10 mcg","10,000 mcg"], "1 mg = 1000 mcg.", "Conversions", `local:order:conv:${n++}`);
  add(O, "How many <b>mg</b> are in <b>1 g</b>?", "1000 mg",
    ["100 mg","10 mg","10,000 mg"], "1 g = 1000 mg.", "Conversions", `local:order:conv:${n++}`);
  add(O, "Convert <b>2.5 g</b> to mg:", "2500 mg",
    ["250 mg","25,000 mg","2,500,000 mg"], "Multiply grams by 1000.", "Conversions", `local:order:conv:${n++}`);
  add(O, "Convert 220 lb to kg (rounded).", "100 kg",
    ["90 kg","110 kg","75 kg"], "kg = lb ÷ 2.2; 220 ÷ 2.2 = 100.", "Conversions", `local:order:conv:${n++}`);
  add(O, "Convert <b>5 mL</b> to teaspoons (tsp).", "1 tsp",
    ["0.5 tsp","2 tsp","3 tsp"], "1 tsp = 5 mL.", "Conversions", `local:order:conv:${n++}`);
  add(O, "Convert <b>30 mL</b> to ounces (approx).", "1 oz",
    ["2 oz","0.5 oz","3 oz"], "Common approximation: 30 mL ≈ 1 oz.", "Conversions", `local:order:conv:${n++}`);

  // Multi-step scenario math
  add(O, "Scenario: Child weighs <b>44 lb</b>. Rx: <b>amoxicillin 20 mg/kg/day</b> divided <b>BID</b>. What is <b>mg per dose</b>?",
    "200 mg per dose",
    ["400 mg per dose","100 mg per dose","20 mg per dose"],
    "44 lb = 20 kg. Daily dose = 20×20 = 400 mg/day. BID → 200 mg/dose.",
    "Multi-step dosing", `local:order:ms:${n++}`);

  add(O, "Scenario: Rx says <b>Take 1 tab PO QID x 10 days</b>. Quantity needed?",
    "40 tablets",
    ["10 tablets","30 tablets","60 tablets"],
    "QID = 4/day. 4×10 = 40.",
    "Days supply/quantity", `local:order:ds:${n++}`);

  add(O, "IV infusion: <b>1000 mL over 8 hours</b>. Rate in <b>mL/hr</b>?",
    "125 mL/hr",
    ["80 mL/hr","100 mL/hr","150 mL/hr"],
    "1000 ÷ 8 = 125 mL/hr.",
    "IV calculations", `local:order:iv:${n++}`);

  add(O, "A DAW code generally relates to:", "Dispense As Written / substitution instructions",
    ["Drug assay weight","Dose after withdrawal","DEA audit window"],
    "DAW codes indicate substitution permissions/requirements.", "Order entry", `local:order:daw:${n++}`);

  add(O, "Insurance reject: <b>Refill too soon</b>. Best first step?",
    "Verify last fill date, day supply, and data entry accuracy",
    ["Override immediately","Dispense without billing","Change drug without prescriber"],
    "Start by verifying timing and entry; then follow plan policy.", "Insurance workflow", `local:order:ins:${n++}`);

  add(O, "A prior authorization (PA) is typically required when:", "Plan requires clinical justification before coverage",
    ["Patient wants cash price","Label printer is down","NDC is missing"],
    "PA is a coverage requirement needing prescriber/plan approval.", "Insurance workflow", `local:order:ins:${n++}`);

  // Compounding basics
  add(O, "A common purpose of a <b>levigating agent</b> is to:", "Help form a smooth paste when incorporating powders",
    ["Sterilize a product","Increase pH rapidly","Increase controlled substance security"],
    "Levigating agents help incorporate powders into bases smoothly.", "Compounding", `local:order:comp:${n++}`);

  add(O, "Alligation is most commonly used to calculate:", "Mixtures of different strengths to reach a target strength",
    ["Days supply for inhalers","NDC selection","DEA schedule"],
    "Alligation helps find proportions needed to reach a target strength.", "Calculations", `local:order:all:${n++}`);

  // ---------- FEDERAL (DEA forms, CS rules, retention, HIPAA, DSCSA) ----------
  const F = DOMAIN.FED;

  add(F, "DEA Form used to order <b>Schedule II</b> controlled substances:", "DEA Form 222",
    ["DEA Form 106","DEA Form 41","DEA Form 224"],
    "DEA 222 is used for ordering Schedule II controlled substances.", "DEA forms", `local:fed:dea:${n++}`);

  add(F, "DEA Form used to report theft/significant loss of controlled substances:", "DEA Form 106",
    ["DEA Form 222","DEA Form 41","DEA Form 224"],
    "DEA 106 is commonly used for theft/loss reporting.", "DEA forms", `local:fed:dea:${n++}`);

  add(F, "DEA Form commonly used to document controlled substance destruction (where applicable):", "DEA Form 41",
    ["DEA Form 106","DEA Form 222","DEA Form 224"],
    "DEA Form 41 is commonly referenced for destruction documentation in training contexts.", "DEA forms", `local:fed:dea:${n++}`);

  add(F, "A common DEA registration application form number referenced in training contexts is:", "DEA Form 224",
    ["DEA Form 222","DEA Form 106","DEA Form 41"],
    "DEA 224 is commonly referenced as a registration form number.", "DEA forms", `local:fed:dea:${n++}`);

  add(F, "Schedule II prescriptions federally:", "Cannot be refilled",
    ["Up to 5 refills in 6 months","Unlimited refills","Refill allowed if pharmacist approves"],
    "CII cannot be refilled under federal law.", "Controlled substance rules", `local:fed:cs:${n++}`);

  add(F, "Schedule III–V refills (typical federal rule):", "Up to 5 refills within 6 months",
    ["No refills allowed","Unlimited refills","Exactly 2 refills"],
    "Common federal rule: CIII–V up to 5 refills within 6 months.", "Controlled substance rules", `local:fed:cs:${n++}`);

  add(F, "Federal controlled substance record retention minimum is commonly:", "2 years",
    ["6 months","1 year","10 years"],
    "Federal baseline is commonly 2 years (states may require longer).", "Record retention", `local:fed:rr:${n++}`);

  add(F, "HIPAA primarily protects:", "Patient health information privacy",
    ["Drug pricing rules","DEA scheduling","NDC formatting"],
    "HIPAA regulates privacy/security of protected health information.", "Privacy", `local:fed:hipaa:${n++}`);

  add(F, "DSCSA primarily relates to:", "Drug supply chain security and traceability",
    ["Patient counseling requirements","DEA diversion reporting only","Insurance formularies"],
    "DSCSA focuses on supply chain tracing/verification.", "FDA/DSCSA", `local:fed:dscsa:${n++}`);

  add(F, "Pseudoephedrine sales controls are most associated with:", "Combat Methamphetamine Epidemic Act-type restrictions",
    ["CLIA regulations","REMS programs","OSHA standards"],
    "Pseudoephedrine is regulated due to diversion risk.", "Restricted products", `local:fed:pse:${n++}`);

  return bank;
}

/* =========================
   Assembly helpers (no learning mode)
========================= */
function partitionByDomain(items){
  const map = new Map();
  items.forEach(it=>{
    if(!map.has(it.domain)) map.set(it.domain, []);
    map.get(it.domain).push(it);
  });
  return map;
}
function randomSampleNoReplace(items, count){
  const s = shuffle(items.slice());
  return s.slice(0, Math.min(count, s.length));
}
function pickFromDomain(domain, need, candidates){
  if(need <= 0) return [];
  let picked = randomSampleNoReplace(candidates, need);
  // backfill with repeats if needed
  if(picked.length < need && candidates.length > 0){
    while(picked.length < need){
      picked.push(candidates[Math.floor(Math.random()*candidates.length)]);
    }
  }
  return picked.slice(0, need);
}
function applyChoiceShuffle(finalQs){
  finalQs.forEach(item=>{
    const correctText = item.choices[item.answerIndex];
    shuffle(item.choices);
    item.answerIndex = item.choices.indexOf(correctText);
  });
}
function ensureExactly90(finalQs){
  const allLocal = buildLocalBank();
  const existing = new Set(finalQs.map(q => q.id));
  let safety = 0;
  while(finalQs.length < TOTAL_QUESTIONS && safety < 20000){
    safety++;
    const c = allLocal[Math.floor(Math.random()*allLocal.length)];
    if(!existing.has(c.id) || finalQs.length > TOTAL_QUESTIONS - 8){
      finalQs.push(c);
      existing.add(c.id);
    }
  }
  return finalQs.slice(0, TOTAL_QUESTIONS);
}

/* =========================
   State
   IMPORTANT: answers stored by INDEX (fixes “answering one answers another”)
========================= */
let state = {
  questions: [],
  index: 0,
  answers: new Map(),     // key: question index, value: selected choice index
  flagged: new Set(),     // stores question index
  timed: false,
  timeLeftSec: 110*60,
  timerHandle: null,
  shuffleQ: true,
  shuffleA: true,
  useOnlineMeds: true,
  isBuilt: false
};

/* =========================
   Elements
========================= */
const startScreen = document.getElementById("startScreen");
const examScreen = document.getElementById("examScreen");
const resultsScreen = document.getElementById("resultsScreen");

const startBtn = document.getElementById("startBtn");
const resetBtn = document.getElementById("resetBtn");

const shuffleQEl = document.getElementById("shuffleQ");
const shuffleAEl = document.getElementById("shuffleA");
const timedEl = document.getElementById("timed");
const timerLenEl = document.getElementById("timerLen");
const useOnlineMedsEl = document.getElementById("useOnlineMeds");
const statusBox = document.getElementById("statusBox");

const qCounter = document.getElementById("qCounter");
const answeredCount = document.getElementById("answeredCount");
const flagCount = document.getElementById("flagCount");
const progressBar = document.getElementById("progressBar");

const qTitle = document.getElementById("qTitle");
const qMeta = document.getElementById("qMeta");
const qStem = document.getElementById("qStem");
const choicesEl = document.getElementById("choices");
const domainTag = document.getElementById("domainTag");

const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const flagBtn = document.getElementById("flagBtn");
const clearBtn = document.getElementById("clearBtn");
const submitBtn = document.getElementById("submitBtn");
const endBtn = document.getElementById("endBtn");
const navGrid = document.getElementById("navGrid");

const timerPill = document.getElementById("timerPill");
const timeLeftEl = document.getElementById("timeLeft");

const overallScoreEl = document.getElementById("overallScore");
const correctCountEl = document.getElementById("correctCount");
const incorrectCountEl = document.getElementById("incorrectCount");
const unansweredCountEl = document.getElementById("unansweredCount");
const domainBreakdownEl = document.getElementById("domainBreakdown");
const reviewList = document.getElementById("reviewList");

const restartBtn = document.getElementById("restartBtn");
const backHomeBtn = document.getElementById("backHomeBtn");

/* =========================
   Timer
========================= */
function stopTimer(){
  if(state.timerHandle){
    clearInterval(state.timerHandle);
    state.timerHandle = null;
  }
}
function startTimer(){
  stopTimer();
  timeLeftEl.textContent = fmtTime(state.timeLeftSec);
  state.timerHandle = setInterval(() => {
    state.timeLeftSec -= 1;
    timeLeftEl.textContent = fmtTime(Math.max(0, state.timeLeftSec));
    if(state.timeLeftSec <= 0){
      stopTimer();
      submitExam(true);
    }
  }, 1000);
}

/* =========================
   Reset / navigation
========================= */
function hardReset(){
  state.questions = [];
  state.index = 0;
  state.answers = new Map();
  state.flagged = new Set();
  state.timed = timedEl.checked;

  const mins = parseInt(timerLenEl.value, 10) || 110;
  state.timeLeftSec = mins * 60;

  state.shuffleQ = shuffleQEl.checked;
  state.shuffleA = shuffleAEl.checked;
  state.useOnlineMeds = useOnlineMedsEl.checked;
  state.isBuilt = false;

  stopTimer();
  statusBox.style.display = "none";
  startScreen.style.display = "";
  examScreen.style.display = "none";
  resultsScreen.style.display = "none";

  submitBtn.disabled = true; // enabled only after build
  startBtn.disabled = false;
}
resetBtn.addEventListener("click", hardReset);
endBtn.addEventListener("click", () => hardReset());
restartBtn.addEventListener("click", () => buildExam());
backHomeBtn.addEventListener("click", () => hardReset());

/* =========================
   Build exam (atomic build)
   - Submit allowed anytime AFTER build
========================= */
async function buildExam(){
  startBtn.disabled = true;
  submitBtn.disabled = true;

  state.shuffleQ = shuffleQEl.checked;
  state.shuffleA = shuffleAEl.checked;
  state.timed = timedEl.checked;
  state.useOnlineMeds = useOnlineMedsEl.checked;

  const mins = parseInt(timerLenEl.value, 10) || 110;
  state.timeLeftSec = mins * 60;

  statusBox.style.display = "none";

  const local = buildLocalBank();
  const byDomainLocal = partitionByDomain(local);

  const medsTarget = COUNTS[DOMAIN.MEDS];
  let dynamicMeds = [];

  if(state.useOnlineMeds){
    statusBox.className = "warnbox tiny";
    statusBox.style.display = "";
    statusBox.textContent = "Fetching fresh medication questions from RxNav… (If it fails, we backfill locally.)";
    try{
      dynamicMeds = await buildDynamicMedsQuestions(medsTarget);
      statusBox.className = "ok tiny";
      statusBox.textContent = `Loaded ${dynamicMeds.length} RxNav medication questions. Building your exam…`;
    } catch(e){
      statusBox.className = "warnbox tiny";
      statusBox.textContent = "RxNav fetch failed (offline/rate-limited). Using local meds only.";
      dynamicMeds = [];
    }
  }

  const final = [];

  // Medications
  const medsFromDynamic = dynamicMeds.slice(0, medsTarget);
  const medsRemaining = medsTarget - medsFromDynamic.length;
  final.push(...medsFromDynamic, ...pickFromDomain(DOMAIN.MEDS, medsRemaining, byDomainLocal.get(DOMAIN.MEDS)||[]));

  // Safety / Order / Federal
  final.push(...pickFromDomain(DOMAIN.SAFETY, COUNTS[DOMAIN.SAFETY], byDomainLocal.get(DOMAIN.SAFETY)||[]));
  final.push(...pickFromDomain(DOMAIN.ORDER, COUNTS[DOMAIN.ORDER], byDomainLocal.get(DOMAIN.ORDER)||[]));
  final.push(...pickFromDomain(DOMAIN.FED, COUNTS[DOMAIN.FED], byDomainLocal.get(DOMAIN.FED)||[]));

  let assembled = ensureExactly90(final);

  if(state.shuffleA) applyChoiceShuffle(assembled);
  if(state.shuffleQ) shuffle(assembled);

  assembled = ensureExactly90(assembled).slice(0, TOTAL_QUESTIONS);

  // IMPORTANT FIX: ensure each question instance has a unique runtimeId
  assembled = assembled.map(q => ({
    ...q,
    runtimeId: q.id + "__RUN__" + Math.random().toString(36).slice(2)
  }));

  state.questions = assembled;
  state.index = 0;
  state.answers = new Map();
  state.flagged = new Set();
  state.isBuilt = (state.questions.length === TOTAL_QUESTIONS);

  // Reveal exam
  startScreen.style.display = "none";
  resultsScreen.style.display = "none";
  examScreen.style.display = "";

  timerPill.style.display = state.timed ? "" : "none";
  if(state.timed){
    timeLeftEl.textContent = fmtTime(state.timeLeftSec);
    startTimer();
  } else {
    stopTimer();
  }

  renderNav();
  renderQuestion();
  renderTopStats();

  // Submit enabled AFTER build, regardless of unanswered
  submitBtn.disabled = false;
}
startBtn.addEventListener("click", buildExam);

/* =========================
   Render
========================= */
function renderTopStats(){
  const answered = state.answers.size;
  const flagged = state.flagged.size;
  qCounter.textContent = String(state.index + 1);
  answeredCount.textContent = String(answered);
  flagCount.textContent = String(flagged);
  progressBar.style.width = `${Math.round((answered / TOTAL_QUESTIONS) * 100)}%`;
}

function renderQuestion(){
  const item = state.questions[state.index];
  qTitle.textContent = `Question ${state.index + 1}`;
  qMeta.textContent = `Reference focus: ${item.ref}`;
  domainTag.textContent = item.domain;

  qStem.innerHTML = item.stem;
  choicesEl.innerHTML = "";

  // KEY FIX: selection stored by INDEX (not by id)
  const selected = state.answers.get(state.index);

  item.choices.forEach((c, idx) => {
    const lab = document.createElement("label");
    lab.className = "choice" + (selected === idx ? " selected" : "");
    const inp = document.createElement("input");
    inp.type = "radio";
    inp.name = "choice";
    inp.value = String(idx);
    if(selected === idx) inp.checked = true;

    inp.addEventListener("change", () => {
      state.answers.set(state.index, idx);
      renderTopStats();
      renderNav();
      renderQuestion(); // refresh selection styling
    });

    const span = document.createElement("div");
    span.innerHTML = `<b>${String.fromCharCode(65 + idx)}.</b> ${c}`;
    lab.appendChild(inp);
    lab.appendChild(span);
    choicesEl.appendChild(lab);
  });

  prevBtn.disabled = state.index === 0;
  nextBtn.disabled = state.index === state.questions.length - 1;

  flagBtn.textContent = state.flagged.has(state.index) ? "Unflag" : "Flag";

  renderTopStats();
  renderNav();
}

function renderNav(){
  navGrid.innerHTML = "";
  state.questions.forEach((_, i) => {
    const b = document.createElement("button");
    b.className = "navbtn";
    b.textContent = String(i + 1);

    if(state.answers.has(i)) b.classList.add("answered");
    if(state.flagged.has(i)) b.classList.add("flagged");
    if(i === state.index) b.classList.add("current");

    b.addEventListener("click", () => {
      state.index = i;
      renderQuestion();
    });
    navGrid.appendChild(b);
  });
}

/* =========================
   Controls
========================= */
prevBtn.addEventListener("click", () => { if(state.index>0){ state.index--; renderQuestion(); } });
nextBtn.addEventListener("click", () => { if(state.index<state.questions.length-1){ state.index++; renderQuestion(); } });

flagBtn.addEventListener("click", () => {
  if(state.flagged.has(state.index)) state.flagged.delete(state.index);
  else state.flagged.add(state.index);
  renderQuestion();
});

clearBtn.addEventListener("click", () => {
  state.answers.delete(state.index);
  renderQuestion();
});

submitBtn.addEventListener("click", () => submitExam(false));

window.addEventListener("keydown", (e) => {
  if(examScreen.style.display === "none") return;
  if(e.key === "ArrowLeft") prevBtn.click();
  if(e.key === "ArrowRight") nextBtn.click();
});

/* =========================
   Scoring + Review
========================= */
function submitExam(fromTimer){
  stopTimer();

  const qs = (state.questions && state.questions.length === TOTAL_QUESTIONS)
    ? state.questions
    : ensureExactly90(state.questions || []);

  let correct = 0;
  let incorrect = 0;
  let unanswered = 0;

  const byDomain = new Map();
  qs.forEach((it, i) => {
    if(!byDomain.has(it.domain)) byDomain.set(it.domain, {correct:0, total:0});
    byDomain.get(it.domain).total += 1;

    // KEY FIX: answer stored by INDEX
    const ans = state.answers.get(i);
    if(ans === undefined){ unanswered++; return; }

    const ok = ans === it.answerIndex;
    if(ok){ correct++; byDomain.get(it.domain).correct += 1; }
    else { incorrect++; }
  });

  const overallPct = Math.round((correct / TOTAL_QUESTIONS) * 100);

  overallScoreEl.textContent = `${overallPct}%`;
  correctCountEl.textContent = String(correct);
  incorrectCountEl.textContent = String(incorrect);
  unansweredCountEl.textContent = String(unanswered);

  domainBreakdownEl.innerHTML = "";
  [...byDomain.entries()].forEach(([domain, stats]) => {
    const pct = stats.total ? Math.round((stats.correct / stats.total) * 100) : 0;
    const pill = document.createElement("div");
    pill.className = "pill";
    pill.innerHTML = `${domain}: <b>${stats.correct}/${stats.total}</b> (${pct}%)`;
    domainBreakdownEl.appendChild(pill);
  });

  reviewList.innerHTML = "";
  qs.forEach((it, i) => {
    const userAns = state.answers.get(i);
    const isCorrect = userAns === it.answerIndex;
    const status = (userAns === undefined) ? "Unanswered" : (isCorrect ? "Correct" : "Incorrect");

    const div = document.createElement("div");
    div.className = "reviewItem";

    const userText = (userAns === undefined) ? "<i>—</i>" : `${String.fromCharCode(65+userAns)}. ${it.choices[userAns]}`;
    const correctText = `${String.fromCharCode(65+it.answerIndex)}. ${it.choices[it.answerIndex]}`;

    div.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div><b>Q${i+1}</b> <span class="muted tiny">(${it.domain})</span></div>
        <div class="${status==='Correct' ? 'correct' : (status==='Incorrect' ? 'incorrect' : 'muted')}">${status}</div>
      </div>
      <div class="stem" style="margin-top:8px">${it.stem}</div>
      <div class="tiny"><b>Your answer:</b> ${userText}</div>
      <div class="tiny"><b>Correct answer:</b> ${correctText}</div>
      <div class="explain tiny"><b>Why:</b> ${it.explanation}</div>
      <div class="tiny muted" style="margin-top:6px"><b>Question ref:</b> ${it.ref}</div>
    `;
    reviewList.appendChild(div);
  });

  examScreen.style.display = "none";
  resultsScreen.style.display = "";
  startScreen.style.display = "none";
  window.scrollTo({top:0, behavior:"smooth"});

  if(fromTimer) alert("Time is up. Your exam has been submitted.");
}

/* =========================
   Boot
========================= */
hardReset();
</script>
</body>
</html>
