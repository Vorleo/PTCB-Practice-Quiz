<!doctype html>
<html lang="en" data-theme="amoled" data-fx-scanlines="1" data-fx-glow="1" data-fx-vignette="1" data-fx-clicks="1" data-fx-beeps="1">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PTCE Study Tool</title>
  <link rel="icon" href="./favicon.svg" type="image/svg+xml">
  <style>
    :root{
      --bg:#000;
      --panel:#0b0f0d;
      --panel2:#070a08;
      --text:#d8ffe8;
      --muted:#9fdcb8;
      --accent:#2cff82;
      --accent2:#00c86a;
      --border:rgba(44,255,130,.35);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --ui: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --font: var(--ui);
      --focus: 0 0 0 3px rgba(44,255,130,.25);
    }
    html,body{height:100%;}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:var(--font);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Effects */
    .fx-layer{position:fixed; inset:0; pointer-events:none; z-index:999;}
    .scanlines{opacity:.18; mix-blend-mode:overlay; background:repeating-linear-gradient(
      to bottom, rgba(255,255,255,.15), rgba(255,255,255,.15) 1px, rgba(0,0,0,0) 3px, rgba(0,0,0,0) 6px
    );}
    .vignette{opacity:.35; background:radial-gradient(circle at center, rgba(0,0,0,0) 55%, rgba(0,0,0,.65) 100%);}
    .glow{opacity:.35; background:radial-gradient(circle at 40% 30%, rgba(44,255,130,.18), transparent 55%); filter: blur(10px);}

    [data-fx-scanlines="0"] .scanlines{display:none;}
    [data-fx-vignette="0"] .vignette{display:none;}
    [data-fx-glow="0"] .glow{display:none;}

    /* Layout */
    .wrap{max-width:1200px; margin:0 auto; padding:16px;}
    header{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(to bottom, rgba(0,0,0,.92), rgba(0,0,0,.7));
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--border);
    }
    .headerRow{display:flex; align-items:center; gap:14px; justify-content:space-between;}
    .themes{display:flex; flex-wrap:wrap; gap:8px; align-items:center;}
    .title{display:flex; align-items:baseline; gap:10px; justify-content:flex-end; white-space:nowrap;}
    .title h1{margin:0; font-size:18px; letter-spacing:.08em; text-transform:uppercase;}
    .title .sub{color:var(--muted); font-size:12px; letter-spacing:.06em}

    .btn{
      appearance:none; border:1px solid var(--border); color:var(--text);
      background:linear-gradient(to bottom, rgba(255,255,255,.04), rgba(255,255,255,.01));
      padding:8px 10px; border-radius:10px; cursor:pointer;
      font-family:var(--font); font-size:12px; letter-spacing:.04em;
      transition:transform .06s ease, border-color .2s ease, background .2s ease;
      user-select:none;
    }
    .btn:hover{border-color:rgba(44,255,130,.6);}
    .btn:active{transform:translateY(1px);}
    .btn:focus{outline:none; box-shadow:var(--focus);}
    .btn.primary{background:linear-gradient(to bottom, rgba(44,255,130,.18), rgba(44,255,130,.06)); border-color:rgba(44,255,130,.55);}
    .btn.danger{border-color:rgba(255,120,120,.45);}
    .btn.toggle.on{border-color:rgba(44,255,130,.75); box-shadow:0 0 0 2px rgba(44,255,130,.16) inset;}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted); font-size:12px;}
    .sep{width:1px; height:24px; background:var(--border); opacity:.8;}

    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:18px;}
    @media (max-width: 860px){ .grid2{grid-template-columns:1fr;} .title{justify-content:flex-start;} }

    .panel{
      background:linear-gradient(to bottom, rgba(255,255,255,.04), rgba(0,0,0,.0)), var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .panel h2{margin:0 0 6px 0; font-size:16px; letter-spacing:.06em; text-transform:uppercase;}
    .panel p{margin:0; color:var(--muted); font-size:13px; line-height:1.35;}
    .panel .actions{margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;}

    /* Boot */
    #boot{
      position:fixed; inset:0; z-index:2000;
      background:radial-gradient(circle at 40% 25%, rgba(44,255,130,.10), transparent 60%), #000;
      display:flex; align-items:center; justify-content:center;
      padding:18px;
    }
    #bootBox{
      width:min(920px, 100%);
      border:1px solid rgba(44,255,130,.35);
      border-radius:18px;
      background:rgba(0,0,0,.55);
      box-shadow:0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    #bootTop{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 14px; border-bottom:1px solid rgba(44,255,130,.22);
      font-family:var(--mono);
      color:var(--muted);
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    #bootScreen{
      padding:14px 14px 10px 14px;
      font-family:var(--mono);
      color:#8effbe;
      font-size:12px;
      line-height:1.28;
      white-space:pre-wrap;
      min-height:260px;
    }
    .cursor{display:inline-block; width:10px; margin-left:2px; background:#8effbe; height:14px; vertical-align:-2px; animation:blink 1s steps(1) infinite;}
    @keyframes blink{50%{opacity:0;}}
    #bootBtns{display:flex; gap:10px; padding:12px 14px; border-top:1px solid rgba(44,255,130,.22); justify-content:flex-end;}

    /* Test UI */
    #view{margin-top:18px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      border:1px solid var(--border); border-radius:16px; padding:10px 12px; background:var(--panel2);
    }
    .topbar-left{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .topbar-right{display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-left:auto;}
    select, input[type="number"]{
      background:rgba(255,255,255,.03); color:var(--text);
      border:1px solid var(--border); border-radius:10px;
      padding:8px 10px; font-family:var(--font); font-size:12px;
    }
    .timer{font-family:var(--mono); color:var(--accent); font-size:13px; letter-spacing:.06em;}

    .qgrid{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(18, minmax(0, 1fr));
      gap:6px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:16px;
      background:var(--panel2);
    }
    @media (max-width: 860px){
      .qgrid{grid-template-columns: repeat(10, minmax(0, 1fr)); gap:6px;}
    }
    .qbox{
      aspect-ratio: 1 / 1;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:center;
      font-size:11px; font-family:var(--mono);
      color:var(--muted);
      background:rgba(255,255,255,.02);
      cursor:pointer;
      user-select:none;
      position:relative;
    }
    .qbox.current{outline:2px solid rgba(44,255,130,.65); outline-offset:0;}
    .qbox.answered{border-color:rgba(44,255,130,.45); color:var(--text);}
    .qbox.flagged::after{
      content:"⚑";
      position:absolute; top:-6px; right:-4px;
      font-size:12px; color:rgba(255,220,120,.95);
      text-shadow:0 0 10px rgba(255,220,120,.45);
    }

    .qcard{margin-top:12px;}
    .qhead{display:flex; justify-content:space-between; align-items:flex-start; gap:10px;}
    .qmeta{color:var(--muted); font-family:var(--mono); font-size:12px;}
    .qtext{font-size:16px; margin:6px 0 0 0; line-height:1.35;}
    .choices{margin-top:12px; display:grid; gap:10px;}
    .choice{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 12px;
      background:rgba(255,255,255,.02);
      cursor:pointer;
      display:flex; gap:10px; align-items:flex-start;
    }
    .choice:hover{border-color:rgba(44,255,130,.55);}
    .choice.disabled{opacity:.45; cursor:not-allowed;}
    .choice input{margin-top:3px;}
    .choice .lbl{flex:1; line-height:1.35; font-size:14px;}
    .navrow{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px;}
    .spacer{flex:1;}

    /* Results */
    .scoreRow{display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
    .kpi{border:1px solid var(--border); border-radius:14px; padding:10px 12px; background:var(--panel2);}
    .kpi .big{font-size:18px; color:var(--accent); font-family:var(--mono);}
    .kpi .small{color:var(--muted); font-size:12px;}
    .resList{margin-top:12px; display:grid; gap:12px;}
    .resItem{border:1px solid var(--border); border-radius:16px; padding:12px; background:var(--panel2);}
    .resItem .tag{font-family:var(--mono); color:var(--muted); font-size:12px;}
    .resItem .why{color:var(--text); margin-top:8px; line-height:1.35;}
    .resItem .ans{margin-top:6px; color:var(--muted); font-size:13px; line-height:1.35;}
    .resItem .ans b{color:var(--text);}

    /* Flashcards */
    .fcWrap{margin-top:12px;}
    .fcControls{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .fcCard{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:18px;
      background:var(--panel2);
      padding:18px;
      min-height:220px;
      display:flex; flex-direction:column; justify-content:space-between;
      cursor:pointer;
      user-select:none;
    }
    .fcQ{font-size:16px; line-height:1.35;}
    .fcA{margin-top:12px; color:var(--muted); line-height:1.35;}
    .fcA b{color:var(--text);}
    .hide{display:none!important;}

    /* Theme palettes */
    [data-theme="amoled"]{ --bg:#000; --panel:#0b0f0d; --panel2:#070a08; --text:#d8ffe8; --muted:#9fdcb8; --accent:#2cff82; --border:rgba(44,255,130,.35); --font: var(--ui); }
    [data-theme="navy"]{ --bg:#071225; --panel:#0b1833; --panel2:#071024; --text:#dbe7ff; --muted:#a9c0ff; --accent:#7cc4ff; --border:rgba(124,196,255,.30); --font: var(--ui); }
    [data-theme="pink"]{ --bg:#220015; --panel:#2b001c; --panel2:#1a0010; --text:#ffe1f1; --muted:#ffb7dc; --accent:#ff6fb7; --border:rgba(255,111,183,.30); --font: var(--ui); }
    [data-theme="vermillion"]{ --bg:#170500; --panel:#220900; --panel2:#130400; --text:#ffe3d6; --muted:#ffb18c; --accent:#ff5a2a; --border:rgba(255,90,42,.30); --font: var(--ui); }
    [data-theme="fallout"]{ --bg:#020403; --panel:#071208; --panel2:#050a06; --text:#d8ffe8; --muted:#9fdcb8; --accent:#2cff82; --border:rgba(44,255,130,.35); --font: var(--mono); }
    [data-theme="vegas"]{ --bg:#080604; --panel:#110d08; --panel2:#070503; --text:#ffe6bf; --muted:#ffd27b; --accent:#ffb84a; --border:rgba(255,184,74,.30); --font: var(--mono); }

    /* ensure theme affects panels on home */
    .panel, .topbar, .qgrid, .qcard, .resItem, .fcCard{border-color:var(--border);}

  </style>
</head>
<body>
  <div class="fx-layer scanlines"></div>
  <div class="fx-layer glow"></div>
  <div class="fx-layer vignette"></div>

  <div id="boot" aria-hidden="false">
    <div id="bootBox">
      <div id="bootTop">
        <div>Vault-Tec Terminal</div>
        <div id="bootHint">Press ENTER to continue</div>
      </div>
      <div id="bootScreen"></div>
      <div id="bootBtns">
        <button class="btn" id="bootSkipBtn">Enter</button>
      </div>
    </div>
  </div>

  <header>
    <div class="wrap headerRow">
      <div class="themes">
        <button class="btn" data-theme-btn="amoled">AMOLED</button>
        <button class="btn" data-theme-btn="fallout">FALLOUT</button>
        <button class="btn" data-theme-btn="vegas">NEW VEGAS</button>
        <button class="btn" data-theme-btn="navy">NAVY</button>
        <button class="btn" data-theme-btn="pink">PINK</button>
        <button class="btn" data-theme-btn="vermillion">VERMILLION</button>
        <span class="sep"></span>
        <button class="btn toggle on" data-fx="scanlines">Scanlines</button>
        <button class="btn toggle on" data-fx="glow">Glow</button>
        <button class="btn toggle on" data-fx="vignette">Vignette</button>
        <button class="btn toggle on" data-fx="clicks">Clicks</button>
        <button class="btn toggle on" data-fx="beeps">Beeps</button>
      </div>
      <div class="title">
        <h1>PTCE Study Tool</h1>
        <div class="sub">Practice test + flashcards</div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="home">
      <div class="grid2">
        <div class="panel">
          <h2>Practice Test</h2>
          <p>90-question PTCE-style practice test (2026 domain weights), with timer, flags, tips, and a full results breakdown.</p>
          <div class="actions">
            <button class="btn primary" id="goTest">Start Test</button>
            <span class="pill">PTCE timing: <b>110 min</b></span>
          </div>
        </div>
        <div class="panel">
          <h2>Flashcards</h2>
          <p>Choose a domain and study with flip cards. Great for quick review between shifts.</p>
          <div class="actions">
            <button class="btn primary" id="goFlash">Open Flashcards</button>
          </div>
        </div>
      </div>
    </div>

    <div id="view" class="hide"></div>
  </main>

  <script>
    // ---------- utilities ----------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));

    function pick(n){ return n<10?`0${n}`:`${n}`; }
    function fmtTime(sec){
      const s = Math.max(0, Math.floor(sec));
      const m = Math.floor(s/60);
      const r = s%60;
      return `${pick(m)}:${pick(r)}`;
    }
    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }
    function uid(){
      return Math.random().toString(36).slice(2)+Date.now().toString(36);
    }

    // ---------- audio (click/beep) ----------
    let audioCtx=null;
    function ensureAudio(){
      if(!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if(audioCtx.state==="suspended"){ audioCtx.resume().catch(()=>{}); }
    }
    function tone(freq=880, dur=0.03, type="square", gain=0.02){
      if(document.documentElement.dataset.fxBeeps==="0") return;
      try{
        ensureAudio();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type=type; o.frequency.value=freq;
        g.gain.value=gain;
        o.connect(g); g.connect(audioCtx.destination);
        o.start();
        o.stop(audioCtx.currentTime+dur);
      }catch(e){}
    }
    function clicky(){
      if(document.documentElement.dataset.fxClicks==="0") return;
      tone(650, 0.02, "square", 0.015);
    }
    document.addEventListener("click", (e)=>{
      const t=e.target;
      if(t && (t.classList?.contains("btn") || t.closest?.(".btn"))){
        clicky();
      }
    }, true);

    // ---------- theme + fx ----------
    function setTheme(t){
      document.documentElement.dataset.theme = t;
      $$("[data-theme-btn]").forEach(b=>b.classList.toggle("on", b.dataset.themeBtn===t));
    }
    $$("[data-theme-btn]").forEach(btn=>{
      btn.addEventListener("click", ()=> setTheme(btn.dataset.themeBtn));
    });

    function setFx(key, on){
      const ds = document.documentElement.dataset;
      if(key==="scanlines") ds.fxScanlines = on?"1":"0";
      if(key==="glow") ds.fxGlow = on?"1":"0";
      if(key==="vignette") ds.fxVignette = on?"1":"0";
      if(key==="clicks") ds.fxClicks = on?"1":"0";
      if(key==="beeps") ds.fxBeeps = on?"1":"0";
    }
    $$("[data-fx]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const key = btn.dataset.fx;
        const ds = document.documentElement.dataset;
        const cur = (key==="scanlines")?ds.fxScanlines:
                    (key==="glow")?ds.fxGlow:
                    (key==="vignette")?ds.fxVignette:
                    (key==="clicks")?ds.fxClicks:ds.fxBeeps;
        const next = cur!=="1";
        setFx(key, next);
        btn.classList.toggle("on", next);
        tone(next?980:320, 0.03, "square", 0.02);
      });
    });

    // ---------- boot (never blocks app) ----------
    const BOOT = {
      el: $("#boot"),
      screen: $("#bootScreen"),
      btn: $("#bootSkipBtn"),
      running: true,
      lines: []
    };

    const BOOT_ASCII = [
"██████╗ ████████╗ ██████╗ ███████╗",
"██╔══██╗╚══██╔══╝██╔════╝ ██╔════╝",
"██████╔╝   ██║   ██║      █████╗  ",
"██╔═══╝    ██║   ██║      ██╔══╝  ",
"██║        ██║   ╚██████╗ ███████╗",
"╚═╝        ╚═╝    ╚═════╝ ╚══════╝",
"",
"PTCE PRACTICE TOOL",
"A Vault Tec program by Joshua Vorhies",
""
    ].join("\n");

    function bootLine(s){
      BOOT.lines.push(s);
      if(BOOT.lines.length>30) BOOT.lines.shift();
      BOOT.screen.innerHTML = escapeHtml(BOOT.lines.join("\n")) + '<span class="cursor"></span>';
    }
    function escapeHtml(str){
      return str.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    }

    function startBoot(){
      BOOT.screen.textContent="";
      BOOT.lines=[];
      bootLine(BOOT_ASCII);
      const checks = [
        "INIT BIOS ............... OK",
        "CHECKSUM ................. OK",
        "MEMORY BANK .............. OK",
        "INPUT DEVICES ............ OK",
        "DISPLAY .................. OK",
        "LOADING MODULES .......... OK",
        "MOUNTING DATA BANKS ...... OK",
      ];
      let i=0;
      const interval = setInterval(()=>{
        if(!BOOT.running){ clearInterval(interval); return; }
        const randHex = ()=>Math.floor(Math.random()*0xFFFF).toString(16).toUpperCase().padStart(4,"0");
        const noise = `SYS ${randHex()}-${randHex()}  CRC:${randHex()}  OK`;
        const line = (Math.random()<0.35) ? noise : checks[i%checks.length];
        bootLine("> " + line);
        tone(880 - (i%5)*80, 0.02, "square", 0.012);
        i++;
        if(i>18){
          bootLine("> READY.");
          bootLine("> Press ENTER to continue.");
          clearInterval(interval);
        }
      }, 140);

      // auto-enable skip after short delay
      setTimeout(()=>{ $("#bootHint").textContent="Press ENTER or click Enter"; }, 800);
      // failsafe: auto hide after 6s (still skippable earlier)
      setTimeout(()=>{ if(BOOT.running) hideBoot(); }, 6500);
    }

    function hideBoot(){
      BOOT.running=false;
      BOOT.el.style.display="none";
    }
    BOOT.btn.addEventListener("click", ()=>{ hideBoot(); });
    window.addEventListener("keydown", (e)=>{
      if(e.key==="Enter" && BOOT.running){ hideBoot(); }
    });

    startBoot();

    // ---------- banks (relative fetch, normalized) ----------
    const BANK_URLS = {
      med: "./med_bank.json",
      safety: "./safety_bank.json",
      order: "./order_bank.json",
      federal: "./federal_bank.json",
    };

    function normalizeBankItem(item, domain){
      if(!item || typeof item!=="object") return null;
      if(!item.question) return null;

      // expected format: {question, correct, wrong[], explanation}
      if(item.correct && Array.isArray(item.wrong)){
        const wrong = item.wrong.filter(x=>x && x!==item.correct);
        if(wrong.length<3) return null;
        const choices = shuffle([item.correct, wrong[0], wrong[1], wrong[2]].slice());
        return {
          id: uid(),
          domain,
          question: String(item.question).trim(),
          choices,
          answerIndex: choices.indexOf(item.correct),
          correctText: item.correct,
          explanation: (item.explanation || "").toString().trim()
        };
      }

      // support already normalized format
      if(Array.isArray(item.choices) && typeof item.answerIndex==="number"){
        const ch = item.choices.filter(Boolean).slice(0,4);
        if(ch.length!==4) return null;
        const ai = clamp(item.answerIndex, 0, 3);
        return {
          id: uid(),
          domain,
          question: String(item.question).trim(),
          choices: ch,
          answerIndex: ai,
          correctText: ch[ai],
          explanation: (item.explanation || "").toString().trim()
        };
      }

      return null;
    }

    const BANKS = { med:[], safety:[], order:[], federal:[] };
    let banksLoaded = false;

    async function loadBanks(){
      if(banksLoaded) return BANKS;
      try{
        const [m,s,o,f] = await Promise.all([
          fetch(BANK_URLS.med, {cache:"no-store"}).then(r=>r.json()),
          fetch(BANK_URLS.safety, {cache:"no-store"}).then(r=>r.json()),
          fetch(BANK_URLS.order, {cache:"no-store"}).then(r=>r.json()),
          fetch(BANK_URLS.federal, {cache:"no-store"}).then(r=>r.json()),
        ]);
        BANKS.med = (Array.isArray(m)?m:[]).map(x=>normalizeBankItem(x,"Medications")).filter(Boolean);
        BANKS.safety = (Array.isArray(s)?s:[]).map(x=>normalizeBankItem(x,"Patient Safety & QA")).filter(Boolean);
        BANKS.order = (Array.isArray(o)?o:[]).map(x=>normalizeBankItem(x,"Order Entry & Processing")).filter(Boolean);
        BANKS.federal = (Array.isArray(f)?f:[]).map(x=>normalizeBankItem(x,"Federal Requirements")).filter(Boolean);
        banksLoaded = true;
        return BANKS;
      }catch(err){
        banksLoaded = true;
        // keep empty; UI will show error in start flows
        console.error(err);
        return BANKS;
      }
    }

    // ---------- navigation ----------
    const home = $("#home");
    const view = $("#view");
    function showHome(){
      view.classList.add("hide");
      home.classList.remove("hide");
      view.innerHTML="";
      window.scrollTo({top:0, behavior:"instant"});
    }
    function showView(html){
      home.classList.add("hide");
      view.classList.remove("hide");
      view.innerHTML = html;
      window.scrollTo({top:0, behavior:"instant"});
    }
    $("#goTest").addEventListener("click", ()=> startTestFlow());
    $("#goFlash").addEventListener("click", ()=> startFlashFlow());

    // ---------- PTCE 2026 weights (from PTCB outline effective Jan 6, 2026) ----------
    // Medications 35%, Federal 18.75%, Patient Safety 23.75%, Order Entry 22.5%
    const PTCE_COUNTS = { meds:32, federal:17, safety:21, order:20 }; // sum 90

    // ---------- Test state ----------
    const TEST = {
      questions: [],
      idx: 0,
      answers: new Map(),  // qid -> choiceIndex (or null)
      flags: new Set(),    // qid
      eliminated: new Map(), // qid -> Set(choiceIndex) eliminated by tip
      tipsLeft: 5,
      timerSec: 110*60,
      timerId: null,
      startedAt: 0,
      running: false,
      timeLeft: 110*60,
      timerMode: "PTCE (110 min)"
    };

    function pickFromBank(bankArr, n){
      const a = bankArr.slice();
      shuffle(a);
      const picked = [];
      for(let i=0;i<n;i++){
        if(a.length){
          const q = a.pop();
          picked.push({...q, id: uid()}); // clone + unique
        }else{
          // if not enough, re-use from original (still clone)
          const fallback = bankArr[Math.floor(Math.random()*bankArr.length)];
          if(fallback) picked.push({...fallback, id: uid()});
        }
      }
      return picked;
    }

    async function buildTest(){
      const b = await loadBanks();
      const totalAvailable = b.med.length + b.safety.length + b.order.length + b.federal.length;
      if(totalAvailable < 20){
        return { ok:false, msg:"Banks failed to load or are too small. Make sure the 4 JSON files are in the same folder as index.html on GitHub Pages." };
      }
      const qs = [
        ...pickFromBank(b.med, PTCE_COUNTS.meds),
        ...pickFromBank(b.federal, PTCE_COUNTS.federal),
        ...pickFromBank(b.safety, PTCE_COUNTS.safety),
        ...pickFromBank(b.order, PTCE_COUNTS.order),
      ];
      shuffle(qs);
      return { ok:true, questions: qs };
    }

    function stopTimer(){
      if(TEST.timerId){ clearInterval(TEST.timerId); TEST.timerId=null; }
      TEST.running=false;
    }
    function startTimer(){
      stopTimer();
      TEST.running=true;
      TEST.timerId = setInterval(()=>{
        TEST.timeLeft--;
        renderTimer();
        if(TEST.timeLeft<=0){
          TEST.timeLeft=0;
          stopTimer();
          submitTest(true);
        }
      }, 1000);
    }
    function renderTimer(){
      const el = $("#timerVal");
      if(el) el.textContent = fmtTime(TEST.timeLeft);
    }

    function domainKey(domain){
      if(domain==="Medications") return "meds";
      if(domain==="Federal Requirements") return "federal";
      if(domain==="Patient Safety & QA") return "safety";
      return "order";
    }

    function renderQGrid(){
      const grid = $("#qgrid");
      if(!grid) return;
      grid.innerHTML = "";
      TEST.questions.forEach((q, i)=>{
        const d = document.createElement("div");
        d.className = "qbox";
        if(i===TEST.idx) d.classList.add("current");
        if(TEST.answers.has(q.id) && TEST.answers.get(q.id) !== null) d.classList.add("answered");
        if(TEST.flags.has(q.id)) d.classList.add("flagged");
        d.textContent = i+1;
        d.addEventListener("click", ()=>{ goto(i); });
        grid.appendChild(d);
      });
    }

    function goto(i){
      TEST.idx = clamp(i, 0, TEST.questions.length-1);
      renderTest();
    }

    function toggleFlag(){
      const q = TEST.questions[TEST.idx];
      if(TEST.flags.has(q.id)) TEST.flags.delete(q.id);
      else TEST.flags.add(q.id);
      renderQGrid();
      const btn = $("#flagBtn");
      if(btn) btn.classList.toggle("on", TEST.flags.has(q.id));
    }

    function clearAnswer(){
      const q = TEST.questions[TEST.idx];
      TEST.answers.set(q.id, null);
      renderQGrid();
      renderTest();
    }

    function applyTip(){
      if(TEST.tipsLeft<=0) return;
      const q = TEST.questions[TEST.idx];
      // eliminate 2 wrong options that are not already eliminated and not correct
      const set = new Set(TEST.eliminated.get(q.id) || []);
      const wrongIdx = [0,1,2,3].filter(i=>i!==q.answerIndex && !set.has(i));
      shuffle(wrongIdx);
      const toElim = wrongIdx.slice(0,2);
      toElim.forEach(i=>set.add(i));
      TEST.eliminated.set(q.id, set);
      TEST.tipsLeft--;
      tone(980, 0.03, "square", 0.02);
      renderTest();
    }

    function renderTest(){
      const q = TEST.questions[TEST.idx];
      const answered = TEST.answers.get(q.id);
      const flagged = TEST.flags.has(q.id);
      const elimSet = new Set(TEST.eliminated.get(q.id) || []);

      const html = `
        <div class="topbar">
          <div class="topbar-left">
            <button class="btn" id="homeBtn">Back</button>
            <span class="pill">Question <b>${TEST.idx+1}</b> / <b>${TEST.questions.length}</b></span>
            <span class="pill">Domain: <b>${escapeHtml(q.domain)}</b></span>
            <span class="pill">Tips left: <b>${TEST.tipsLeft}</b></span>
          </div>
          <div class="topbar-right">
            <span class="timer">⏱ <span id="timerVal">${fmtTime(TEST.timeLeft)}</span></span>
            <button class="btn primary" id="submitBtn">Submit</button>
          </div>
        </div>

        <div class="qgrid" id="qgrid"></div>

        <div class="panel qcard">
          <div class="qhead">
            <div>
              <div class="qmeta">${escapeHtml(q.domain)} • ID ${q.id.slice(-6)}</div>
              <div class="qtext"><b>Q${TEST.idx+1}.</b> ${escapeHtml(q.question)}</div>
            </div>
          </div>

          <div class="choices">
            ${q.choices.map((c, i)=>{
              const dis = elimSet.has(i);
              const chk = (answered===i) ? "checked" : "";
              return `
                <label class="choice ${dis?"disabled":""}">
                  <input type="radio" name="choice" value="${i}" ${chk} ${dis?"disabled":""}>
                  <div class="lbl">${escapeHtml(c)}</div>
                </label>
              `;
            }).join("")}
          </div>

          <div class="navrow">
            <button class="btn" id="prevBtn">Prev</button>
            <button class="btn toggle ${flagged?"on":""}" id="flagBtn">Flag</button>
            <button class="btn" id="nextBtn">Next</button>
            <span class="spacer"></span>
            <button class="btn" id="tipBtn" ${TEST.tipsLeft<=0?"disabled":""}>Use Tip</button>
            <button class="btn" id="clearBtn">Clear Answer</button>
          </div>
        </div>
      `;

      showView(html);
      renderQGrid();

      $("#homeBtn").addEventListener("click", ()=>{ stopTimer(); showHome(); });
      $("#submitBtn").addEventListener("click", ()=> submitTest(false));
      $("#prevBtn").addEventListener("click", ()=> goto(TEST.idx-1));
      $("#nextBtn").addEventListener("click", ()=> goto(TEST.idx+1));
      $("#flagBtn").addEventListener("click", ()=> toggleFlag());
      $("#clearBtn").addEventListener("click", ()=> clearAnswer());
      $("#tipBtn").addEventListener("click", ()=> applyTip());

      $$(".choice input").forEach(inp=>{
        inp.addEventListener("change", (e)=>{
          const val = parseInt(e.target.value, 10);
          TEST.answers.set(q.id, val);
          renderQGrid();
        });
      });

      renderTimer();
    }

    function renderTestStart(configError){
      const timerOptions = [
        {label:"PTCE (110 min)", sec:110*60},
        {label:"2 hours (120 min)", sec:120*60},
        {label:"1h 30m (90 min)", sec:90*60},
        {label:"1 hour (60 min)", sec:60*60},
        {label:"30 min", sec:30*60},
      ];
      const optHtml = timerOptions.map(o=>`<option value="${o.sec}">${o.label}</option>`).join("");

      showView(`
        <div class="panel">
          <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center;">
            <div>
              <h2 style="margin:0 0 6px 0;">Practice Test</h2>
              <p style="margin:0;color:var(--muted);">90 questions • 2026 domain weights (Medications 35%, Federal 18.75%, Safety 23.75%, Order Entry 22.5%) • Flag + tips + results explanations</p>
            </div>
            <button class="btn" id="backHome">Back</button>
          </div>

          ${configError?`<div style="margin-top:12px;color:#ffb0b0;">${escapeHtml(configError)}</div>`:""}

          <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <span class="pill">Timer</span>
            <select id="timerSelect">${optHtml}</select>
            <span class="sep"></span>
            <span class="pill">Tips per test: <b>5</b></span>
            <span class="pill">Questions: <b>90</b></span>
          </div>

          <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn primary" id="beginBtn">Begin Test</button>
          </div>
        </div>
      `);

      $("#backHome").addEventListener("click", ()=> showHome());
      $("#beginBtn").addEventListener("click", async ()=>{
        const sec = parseInt($("#timerSelect").value,10) || (110*60);
        await beginTest(sec);
      });
    }

    async function beginTest(seconds){
      const built = await buildTest();
      if(!built.ok){
        renderTestStart(built.msg);
        return;
      }
      TEST.questions = built.questions;
      TEST.idx = 0;
      TEST.answers = new Map();
      TEST.flags = new Set();
      TEST.eliminated = new Map();
      TEST.tipsLeft = 5;
      TEST.timeLeft = seconds;
      TEST.startedAt = Date.now();
      startTimer();
      renderTest();
    }

    async function startTestFlow(){
      renderTestStart(null);
    }

    function scoreTest(){
      let correct=0, answered=0;
      const byDomain = { meds:{c:0,t:0}, federal:{c:0,t:0}, safety:{c:0,t:0}, order:{c:0,t:0} };
      TEST.questions.forEach(q=>{
        const dk = domainKey(q.domain);
        byDomain[dk].t++;
        const a = TEST.answers.has(q.id) ? TEST.answers.get(q.id) : null;
        if(a!==null && a!==undefined) answered++;
        if(a===q.answerIndex){
          correct++;
          byDomain[dk].c++;
        }
      });
      return {correct, answered, total:TEST.questions.length, byDomain};
    }

    function pct(n,d){ return d?Math.round((n/d)*100):0; }

    function submitTest(auto){
      stopTimer();
      const {correct, answered, total, byDomain} = scoreTest();
      const percent = pct(correct,total);

      const kpi = (label, big, small)=>`
        <div class="kpi">
          <div class="big">${big}</div>
          <div class="small">${label}${small?` • ${small}`:""}</div>
        </div>`;

      const bdRow = (name, obj)=>`
        <div class="kpi">
          <div class="big">${obj.c}/${obj.t}</div>
          <div class="small">${name} • ${pct(obj.c,obj.t)}%</div>
        </div>`;

      const resItems = TEST.questions.map((q,i)=>{
        const a = TEST.answers.has(q.id) ? TEST.answers.get(q.id) : null;
        const your = (a===null||a===undefined) ? "— (blank)" : q.choices[a];
        const corr = q.choices[q.answerIndex];
        const why = q.explanation ? q.explanation : "No explanation provided in bank for this item.";
        const ok = (a===q.answerIndex);
        return `
          <div class="resItem">
            <div class="tag">Q${i+1} • ${escapeHtml(q.domain)} • ${ok?"✅ Correct":"❌ Incorrect"}</div>
            <div class="why"><b>${escapeHtml(q.question)}</b></div>
            <div class="ans">Your answer: <b>${escapeHtml(your)}</b><br>Correct answer: <b>${escapeHtml(corr)}</b></div>
            <div class="ans" style="margin-top:8px;">Why this is correct:</div>
            <div class="why">${escapeHtml(why)}</div>
          </div>
        `;
      }).join("");

      showView(`
        <div class="panel">
          <div class="scoreRow">
            ${kpi("Score", `${correct}/${total}`, `${percent}%`)}
            ${kpi("Answered", `${answered}/${total}`, "")}
            ${kpi("Time left", fmtTime(TEST.timeLeft), auto?"Auto-submitted":"")}
            <span class="spacer"></span>
            <button class="btn" id="reviewBtn">Review</button>
            <button class="btn primary" id="homeBtn2">Home</button>
          </div>

          <div style="margin-top:10px; display:flex; gap:12px; flex-wrap:wrap;">
            ${bdRow("Medications", byDomain.meds)}
            ${bdRow("Federal", byDomain.federal)}
            ${bdRow("Safety", byDomain.safety)}
            ${bdRow("Order Entry", byDomain.order)}
          </div>
        </div>

        <div class="resList" id="resList" style="display:none;">
          ${resItems}
        </div>
      `);

      $("#homeBtn2").addEventListener("click", ()=> showHome());
      $("#reviewBtn").addEventListener("click", ()=>{
        const rl = $("#resList");
        rl.style.display = (rl.style.display==="none") ? "grid" : "none";
        $("#reviewBtn").textContent = (rl.style.display==="none") ? "Review" : "Hide Review";
      });
    }

    // ---------- Flashcards ----------
    const FLASH = {
      domain: "med",
      cards: [],
      idx: 0,
      showAnswer: false,
      shuffled: true,
    };

    function flashDomainLabel(k){
      return (k==="med")?"Medications":
             (k==="federal")?"Federal Requirements":
             (k==="safety")?"Patient Safety & QA":"Order Entry & Processing";
    }

    async function startFlashFlow(){
      const b = await loadBanks();
      const ok = b.med.length+b.safety.length+b.order.length+b.federal.length;
      if(ok < 20){
        showView(`<div class="panel"><h2>Flashcards</h2><p style="color:var(--muted)">Banks failed to load. Ensure the JSON files are in the same folder as index.html.</p><div class="actions"><button class="btn" id="backH">Back</button></div></div>`);
        $("#backH").addEventListener("click", ()=> showHome());
        return;
      }
      renderFlashSelect();
    }

    function renderFlashSelect(){
      showView(`
        <div class="panel">
          <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center;">
            <div>
              <h2 style="margin:0 0 6px 0;">Flashcards</h2>
              <p style="margin:0;color:var(--muted);">Pick a domain, then tap the card to flip. Use shuffle for variety.</p>
            </div>
            <button class="btn" id="backHomeF">Back</button>
          </div>

          <div class="actions" style="margin-top:12px;">
            <button class="btn primary" data-fsel="med">Medications</button>
            <button class="btn primary" data-fsel="federal">Federal Requirements</button>
            <button class="btn primary" data-fsel="safety">Patient Safety & QA</button>
            <button class="btn primary" data-fsel="order">Order Entry & Processing</button>
          </div>
        </div>
      `);
      $("#backHomeF").addEventListener("click", ()=> showHome());
      $$("[data-fsel]").forEach(b=>{
        b.addEventListener("click", ()=>{
          FLASH.domain = b.dataset.fsel;
          buildFlashDeck();
          renderFlash();
        });
      });
    }

    function buildFlashDeck(){
      let bank = BANKS.med;
      if(FLASH.domain==="federal") bank = BANKS.federal;
      if(FLASH.domain==="safety") bank = BANKS.safety;
      if(FLASH.domain==="order") bank = BANKS.order;
      const cards = bank.slice();
      if(FLASH.shuffled) shuffle(cards);
      FLASH.cards = cards;
      FLASH.idx = 0;
      FLASH.showAnswer = false;
    }

    function renderFlash(){
      const c = FLASH.cards[FLASH.idx];
      const total = FLASH.cards.length || 0;
      showView(`
        <div class="topbar">
          <div class="topbar-left">
            <button class="btn" id="flashBack">Back</button>
            <span class="pill">Deck: <b>${flashDomainLabel(FLASH.domain)}</b></span>
            <span class="pill">Card <b>${FLASH.idx+1}</b> / <b>${total}</b></span>
          </div>
          <div class="topbar-right">
            <button class="btn toggle ${FLASH.shuffled?"on":""}" id="shuffleBtn">Shuffle</button>
            <button class="btn" id="homeFromFlash">Home</button>
          </div>
        </div>

        <div class="fcWrap">
          <div class="fcControls">
            <button class="btn" id="fcPrev">Prev</button>
            <button class="btn" id="fcNext">Next</button>
            <span class="spacer"></span>
            <span class="pill">Tap card to flip</span>
          </div>

          <div class="fcCard" id="fcCard">
            <div>
              <div class="qmeta">${escapeHtml(c.domain)} • ${escapeHtml(c.id.slice(-6))}</div>
              <div class="fcQ"><b>${escapeHtml(c.question)}</b></div>
              <div class="fcA" id="fcA" style="display:${FLASH.showAnswer?"block":"none"};">
                <b>Answer:</b> ${escapeHtml(c.correctText)}<br><br>
                ${c.explanation?`<b>Why:</b> ${escapeHtml(c.explanation)}`:""}
              </div>
            </div>
            <div class="qmeta">${FLASH.showAnswer?"(showing answer)":"(question only)"}</div>
          </div>
        </div>
      `);

      $("#flashBack").addEventListener("click", ()=> renderFlashSelect());
      $("#homeFromFlash").addEventListener("click", ()=> showHome());
      $("#shuffleBtn").addEventListener("click", ()=>{ FLASH.shuffled=!FLASH.shuffled; buildFlashDeck(); renderFlash(); });
      $("#fcPrev").addEventListener("click", ()=>{ FLASH.idx = (FLASH.idx-1+FLASH.cards.length)%FLASH.cards.length; FLASH.showAnswer=false; renderFlash(); });
      $("#fcNext").addEventListener("click", ()=>{ FLASH.idx = (FLASH.idx+1)%FLASH.cards.length; FLASH.showAnswer=false; renderFlash(); });
      $("#fcCard").addEventListener("click", ()=>{ FLASH.showAnswer=!FLASH.showAnswer; tone(740,0.02,"square",0.012); renderFlash(); });
    }

    // ---------- init ----------
    // do not block on banks: just warm load
    loadBanks();
    // initial theme
    setTheme(document.documentElement.dataset.theme || "amoled");
  </script>
</body>
</html>
