<!doctype html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PTCB Practice Test</title>

<style>
/* ================= THEMES ================= */
:root{
  --bg:#f6f7fb; --card:#ffffff; --text:#111; --muted:#555;
  --border:#ddd; --accent:#2563eb;
}
html[data-theme="dark"]{
  --bg:#0a0f1c; --card:#121a2b; --text:#e5e7eb; --muted:#9ca3af;
  --border:#2a3550; --accent:#60a5fa;
}
html[data-theme="terminal"]{
  --bg:#020403; --card:#06130b; --text:#7cffb2; --muted:#54c98a;
  --border:#0f2c1b; --accent:#00ff88;
}
html[data-theme="purple"]{
  --bg:#120018; --card:#1e0030; --text:#f3d9ff; --muted:#d8b4fe;
  --border:#3c0066; --accent:#c084fc;
}
html[data-theme="lab"]{
  --bg:#f4fdff; --card:#ffffff; --text:#003c44; --muted:#2b6b74;
  --border:#c8eef5; --accent:#00a8a8;
}
html[data-theme="synthwave"]{
  --bg:#0a0016; --card:#16002b; --text:#ffd9ff; --muted:#f0abfc;
  --border:#4b0073; --accent:#ff00aa;
}
html[data-theme="medical"]{
  --bg:#f4fbff; --card:#ffffff; --text:#0b1f2a; --muted:#335a6b;
  --border:#cfe9f5; --accent:#00a8a8;
}
html[data-theme="paper"]{
  --bg:#fbf7ef; --card:#fffdf8; --text:#1b1b1b; --muted:#5a5a5a;
  --border:#e7ddcc; --accent:#8b5cf6;
}

/* ================= BASE ================= */
body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui; }
header{ padding:15px; background:var(--card); border-bottom:1px solid var(--border); }
.wrap{ max-width:1000px; margin:auto; padding:20px; }
.card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:15px; margin-bottom:15px; }
h2,h3{ margin:0 0 10px; }
small,.muted{ color:var(--muted); }

button{
  padding:10px 14px; border-radius:10px; border:none; font-weight:700; cursor:pointer;
  background:var(--accent); color:white; margin:4px;
}
button.alt{ background:var(--card); border:1px solid var(--border); color:var(--text); }
button:disabled{ opacity:.55; cursor:not-allowed; }

.choice{ border:1px solid var(--border); padding:10px; border-radius:10px; margin-bottom:8px; cursor:pointer; }
.navgrid{ display:grid; grid-template-columns:repeat(10,1fr); gap:6px; margin-top:10px; }
.navbtn{ border:1px solid var(--border); padding:8px; text-align:center; border-radius:8px; cursor:pointer; }
.navbtn.answered{ background:rgba(34,197,94,.18); }
.navbtn.flagged{ background:rgba(245,158,11,.22); }
.navbtn.current{ outline:2px solid var(--accent); }

.flashcard{
  font-size:20px; padding:40px; text-align:center; border:1px solid var(--border);
  border-radius:12px; cursor:pointer; user-select:none;
}

.row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
.pill{
  display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid var(--border);
  background:rgba(127,127,127,.08); font-weight:700; font-size:12px;
}
input[type="checkbox"]{ transform:scale(1.15); }

@media (max-width: 520px){
  .navgrid{ grid-template-columns:repeat(8,1fr); }
  .flashcard{ font-size:18px; padding:28px; }
}
</style>
</head>

<body>
<header>
  <h2>PTCB Practice Test</h2>

  <div class="row">
    <button class="alt" onclick="setTheme('light')">Light</button>
    <button class="alt" onclick="setTheme('dark')">Dark</button>
    <button class="alt" onclick="setTheme('terminal')">Terminal</button>
    <button class="alt" onclick="setTheme('purple')">Purple</button>
    <button class="alt" onclick="setTheme('lab')">Lab</button>
    <button class="alt" onclick="setTheme('synthwave')">Synthwave</button>
    <button class="alt" onclick="setTheme('medical')">Medical</button>
    <button class="alt" onclick="setTheme('paper')">Paper</button>
  </div>
</header>

<div class="wrap">

  <!-- HOME -->
  <div id="home" class="card">
    <h3>Home</h3>
    <div class="muted">
      Weighted 90-question practice test (2026 mapping): <b>32 Medications</b> • <b>21 Patient Safety</b> • <b>20 Order Entry/Math</b> • <b>17 Federal</b>.
    </div>

    <div class="row" style="margin-top:10px;">
      <span class="pill"><label><input id="optTimed" type="checkbox"> Timed</label></span>
      <span class="pill">
        <label><input id="optRxNav" type="checkbox" checked> Use RxNav (optional)</label>
      </span>
      <span class="pill">
        <label><input id="optShuffleQ" type="checkbox" checked> Shuffle questions</label>
      </span>
    </div>

    <div class="row" style="margin-top:10px;">
      <button onclick="startTest()">Start Practice Test</button>
      <button onclick="goFlashHome()">Flashcards</button>
    </div>

    <div id="status" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- TEST -->
  <div id="test" class="card" style="display:none">
    <div class="row" style="justify-content:space-between;">
      <div class="row">
        <span class="pill">Question <b id="qNum">1</b>/90</span>
        <span class="pill">Answered <b id="answeredCount">0</b></span>
        <span class="pill">Flagged <b id="flaggedCount">0</b></span>
        <span class="pill" id="timerPill" style="display:none;">Time <b id="timerText">110:00</b></span>
        <span class="pill" id="domainPill">—</span>
      </div>
      <div class="row">
        <button class="alt" onclick="flagQ()">Flag</button>
        <button class="alt" onclick="clearQ()">Clear</button>
        <button onclick="submitTest()">Submit</button>
        <button class="alt" onclick="goHome()">Home</button>
      </div>
    </div>

    <h3 id="question" style="margin-top:12px;"></h3>
    <div id="choices"></div>

    <div class="row" style="justify-content:space-between;">
      <div class="row">
        <button class="alt" onclick="prevQ()">Prev</button>
        <button onclick="nextQ()">Next</button>
      </div>
      <div class="muted"><small>Leave blank if you want. Submit anytime.</small></div>
    </div>

    <div id="nav" class="navgrid"></div>
  </div>

  <!-- FLASH HOME -->
  <div id="flashHome" class="card" style="display:none">
    <h3>Flashcards</h3>
    <div class="muted">Pick a PTCE section to study.</div>

    <div class="row" style="margin-top:10px;">
      <button onclick="openFlash('MEDS')">Medications</button>
      <button onclick="openFlash('SAFETY')">Patient Safety</button>
      <button onclick="openFlash('ORDER')">Order Entry / Math</button>
      <button onclick="openFlash('FED')">Federal</button>
      <button class="alt" onclick="openFlash('MIXED')">Mixed</button>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="alt" onclick="goHome()">Home</button>
    </div>
  </div>

  <!-- FLASH VIEW -->
  <div id="flash" class="card" style="display:none">
    <div class="row" style="justify-content:space-between;">
      <div class="row">
        <span class="pill">Deck <b id="flashDeckName">—</b></span>
        <span class="pill">Card <b id="flashPos">1</b>/<b id="flashTotal">1</b></span>
        <span class="pill">Side <b id="flashSide">Front</b></span>
      </div>
      <div class="row">
        <button onclick="nextFlash()">Next</button>
        <button class="alt" onclick="goFlashHome()">Decks</button>
        <button class="alt" onclick="goHome()">Home</button>
      </div>
    </div>

    <div id="flashCard" class="flashcard" style="margin-top:12px;">Tap to Start</div>
  </div>

</div>

<script>
/* ================= THEME SYSTEM ================= */
function setTheme(t){
  document.documentElement.setAttribute("data-theme", t);
  localStorage.setItem("theme", t);
}
(function(){
  const saved = localStorage.getItem("theme");
  if(saved) setTheme(saved);
})();

/* ================= CONSTANTS / WEIGHTS ================= */
const DOMAIN = { MEDS:"Medications", SAFETY:"Patient Safety", ORDER:"Order Entry / Math", FED:"Federal Requirements" };
const COUNTS = { MEDS:32, SAFETY:21, ORDER:20, FED:17 };
const TOTAL = 90;

/* ================= STATE ================= */
let questions = [];              // [{domain, stem, choices[4], answerIndex, why}]
let answers = new Map();         // key = question index, value = choice index
let flags = new Set();           // flagged question indexes
let index = 0;

let timer = null;
let timed = false;
let timeLeft = 110*60;

const statusEl = document.getElementById("status");

/* ================= UTIL ================= */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function fmtTime(sec){
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return `${m}:${String(s).padStart(2,'0')}`;
}
function uniqBy(arr, keyFn){
  const seen=new Set(), out=[];
  for(const x of arr){
    const k=keyFn(x);
    if(seen.has(k)) continue;
    seen.add(k); out.push(x);
  }
  return out;
}

/* ================= RXNAV (OPTIONAL) ================= */
const RXNAV_BASE="https://rxnav.nlm.nih.gov/REST";
const RX_SEEDS=["lisinopril","losartan","metformin","atorvastatin","sertraline","omeprazole","gabapentin","tamsulosin","albuterol","pantoprazole","amoxicillin","cephalexin","doxycycline","azithromycin","warfarin","clopidogrel","levothyroxine","insulin lispro","insulin glargine"];
async function fetchJson(url, signal){
  const res=await fetch(url,{signal});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}
function withTimeout(promiseFactory, ms){
  const ctrl=new AbortController();
  const t=setTimeout(()=>ctrl.abort(), ms);
  return promiseFactory(ctrl.signal).finally(()=>clearTimeout(t));
}
function extractBrands(name){
  const matches=name.match(/\[([^\]]+)\]/g)||[];
  return matches.map(m=>m.replace(/^\[/,'').replace(/\]$/,'').trim()).filter(Boolean);
}
async function rxnavBrandsForIngredient(ingredient, signal){
  const url=`${RXNAV_BASE}/drugs.json?name=${encodeURIComponent(ingredient)}`;
  const data=await fetchJson(url, signal);
  const groups=(data?.drugGroup?.conceptGroup)||[];
  const brands=new Set();

  const sbd=groups.find(g=>g.tty==="SBD");
  for(const c of (sbd?.conceptProperties||[])){
    const nm=c?.name||"";
    for(const b of extractBrands(nm)) brands.add(b);
  }
  const bn=groups.find(g=>g.tty==="BN");
  for(const c of (bn?.conceptProperties||[])){
    if(c?.name) brands.add(c.name.trim());
  }
  return Array.from(brands);
}

/* ================= BIG OFFLINE BANKS ================= */
/* Medication dataset used to generate MANY questions */
const MEDS = [
  {g:"atorvastatin", b:["Lipitor"], cls:"statin", ind:"high cholesterol"},
  {g:"rosuvastatin", b:["Crestor"], cls:"statin", ind:"high cholesterol"},
  {g:"simvastatin", b:["Zocor"], cls:"statin", ind:"high cholesterol"},
  {g:"pravastatin", b:["Pravachol"], cls:"statin", ind:"high cholesterol"},
  {g:"lisinopril", b:["Prinivil","Zestril"], cls:"ACE inhibitor", ind:"hypertension"},
  {g:"enalapril", b:["Vasotec"], cls:"ACE inhibitor", ind:"hypertension"},
  {g:"losartan", b:["Cozaar"], cls:"ARB", ind:"hypertension"},
  {g:"valsartan", b:["Diovan"], cls:"ARB", ind:"hypertension"},
  {g:"amlodipine", b:["Norvasc"], cls:"calcium channel blocker", ind:"hypertension/angina"},
  {g:"metoprolol", b:["Lopressor","Toprol XL"], cls:"beta blocker", ind:"hypertension/angina"},
  {g:"carvedilol", b:["Coreg"], cls:"beta blocker", ind:"heart failure"},
  {g:"hydrochlorothiazide", b:["Microzide"], cls:"thiazide diuretic", ind:"hypertension"},
  {g:"furosemide", b:["Lasix"], cls:"loop diuretic", ind:"edema"},
  {g:"spironolactone", b:["Aldactone"], cls:"potassium-sparing diuretic", ind:"edema/heart failure"},
  {g:"metformin", b:["Glucophage"], cls:"biguanide", ind:"type 2 diabetes"},
  {g:"glipizide", b:["Glucotrol"], cls:"sulfonylurea", ind:"type 2 diabetes"},
  {g:"sitagliptin", b:["Januvia"], cls:"DPP-4 inhibitor", ind:"type 2 diabetes"},
  {g:"empagliflozin", b:["Jardiance"], cls:"SGLT2 inhibitor", ind:"type 2 diabetes"},
  {g:"levothyroxine", b:["Synthroid","Levoxyl"], cls:"thyroid hormone", ind:"hypothyroidism"},
  {g:"omeprazole", b:["Prilosec"], cls:"PPI", ind:"GERD"},
  {g:"pantoprazole", b:["Protonix"], cls:"PPI", ind:"GERD"},
  {g:"famotidine", b:["Pepcid"], cls:"H2 blocker", ind:"GERD"},
  {g:"ondansetron", b:["Zofran"], cls:"antiemetic", ind:"nausea/vomiting"},
  {g:"sertraline", b:["Zoloft"], cls:"SSRI", ind:"depression/anxiety"},
  {g:"fluoxetine", b:["Prozac"], cls:"SSRI", ind:"depression"},
  {g:"escitalopram", b:["Lexapro"], cls:"SSRI", ind:"depression/anxiety"},
  {g:"duloxetine", b:["Cymbalta"], cls:"SNRI", ind:"depression/neuropathic pain"},
  {g:"gabapentin", b:["Neurontin"], cls:"neuropathic analgesic", ind:"neuropathic pain"},
  {g:"pregabalin", b:["Lyrica"], cls:"neuropathic analgesic", ind:"neuropathic pain"},
  {g:"amoxicillin", b:["Amoxil"], cls:"penicillin antibiotic", ind:"bacterial infection"},
  {g:"amoxicillin/clavulanate", b:["Augmentin"], cls:"penicillin antibiotic", ind:"bacterial infection"},
  {g:"cephalexin", b:["Keflex"], cls:"cephalosporin antibiotic", ind:"bacterial infection"},
  {g:"azithromycin", b:["Zithromax"], cls:"macrolide antibiotic", ind:"bacterial infection"},
  {g:"doxycycline", b:["Vibramycin"], cls:"tetracycline antibiotic", ind:"bacterial infection"},
  {g:"clindamycin", b:["Cleocin"], cls:"lincosamide antibiotic", ind:"bacterial infection"},
  {g:"sulfamethoxazole/trimethoprim", b:["Bactrim","Septra"], cls:"sulfonamide antibiotic", ind:"bacterial infection"},
  {g:"albuterol", b:["Ventolin","ProAir"], cls:"SABA bronchodilator", ind:"asthma relief"},
  {g:"fluticasone", b:["Flonase","Flovent"], cls:"corticosteroid", ind:"allergic rhinitis/asthma"},
  {g:"montelukast", b:["Singulair"], cls:"leukotriene modifier", ind:"asthma/allergies"},
  {g:"tamsulosin", b:["Flomax"], cls:"alpha-1 blocker", ind:"BPH"},
  {g:"finasteride", b:["Proscar"], cls:"5-alpha reductase inhibitor", ind:"BPH/hair loss"},
  {g:"warfarin", b:["Coumadin"], cls:"anticoagulant", ind:"clot prevention"},
  {g:"apixaban", b:["Eliquis"], cls:"DOAC", ind:"clot prevention"},
  {g:"rivaroxaban", b:["Xarelto"], cls:"DOAC", ind:"clot prevention"},
  {g:"clopidogrel", b:["Plavix"], cls:"antiplatelet", ind:"stroke/MI prevention"},
  {g:"acetaminophen", b:["Tylenol"], cls:"analgesic/antipyretic", ind:"pain/fever"},
  {g:"ibuprofen", b:["Advil","Motrin"], cls:"NSAID", ind:"pain/fever"},
  {g:"naproxen", b:["Aleve","Naprosyn"], cls:"NSAID", ind:"pain/inflammation"},
  {g:"valacyclovir", b:["Valtrex"], cls:"antiviral", ind:"herpes"},
  {g:"acyclovir", b:["Zovirax"], cls:"antiviral", ind:"herpes"},
  {g:"prednisone", b:["Deltasone"], cls:"corticosteroid", ind:"inflammation"}
];

const SUFFIX_RULES = [
  {suffix:"-pril", cls:"ACE inhibitor"},
  {suffix:"-sartan", cls:"ARB"},
  {suffix:"-olol", cls:"beta blocker"},
  {suffix:"-statin", cls:"statin"},
  {suffix:"-prazole", cls:"PPI"},
  {suffix:"-cycline", cls:"tetracycline antibiotic"},
  {suffix:"-vir", cls:"antiviral"}
];

const SAFETY_BANK = [
  ["USP <800> focuses on:", "Hazardous drug handling safety", ["Sterile compounding only","Insurance rules","DEA scheduling"]],
  ["USP <797> covers:", "Sterile compounding", ["Non-sterile compounding","Insurance billing","DEA forms"]],
  ["USP <795> covers:", "Non-sterile compounding", ["Sterile compounding","Hazardous-only","Insurance billing"]],
  ["LASA stands for:", "Look-alike/sound-alike", ["Long-acting/short-acting","Lot-and-serial-audit","Label-all/store-all"]],
  ["Best practice: leading zero is:", "Write 0.5 mg (not .5 mg)", ["Write .5 mg only","Write 00.5 mg","Never use decimals"]],
  ["Best practice: trailing zero is:", "Avoid 5.0 mg; write 5 mg", ["Always write 5.0 mg","Write 5.00 mg","Use commas instead"]],
  ["A commonly high-alert medication is:", "Insulin", ["Docusate","Loratadine","Saline nasal spray"]],
  ["If a dose appears unsafe, a technician should:", "Refer to the pharmacist for clinical review", ["Change the dose","Fill as written","Call insurance first"]],
  ["FDA MedWatch is used to report:", "Serious adverse events/product quality issues", ["Theft/loss to DEA","HIPAA violations","Insurance fraud"]],
  ["Garbing: best first step is typically:", "Hand hygiene", ["Gloves","Mask","Apply fragrance"]],
  ["High osmolarity TPN typically requires:", "Central line", ["Peripheral IV","IM injection","Oral administration"]],
  ["Tall-man lettering is used to:", "Reduce look-alike confusion", ["Increase reimbursement","Replace NDC","Mark controlled drugs only"]]
];

const FEDERAL_BANK = [
  ["DEA form for Schedule II ordering?", "DEA Form 222", ["DEA Form 106","DEA Form 41","DEA Form 224"]],
  ["DEA form to report theft/significant loss?", "DEA Form 106", ["DEA Form 222","DEA Form 41","DEA Form 224"]],
  ["DEA form associated with destruction documentation?", "DEA Form 41", ["DEA Form 222","DEA Form 106","DEA Form 224"]],
  ["Schedule II prescriptions federally:", "Cannot be refilled", ["Up to 5 refills in 6 months","Unlimited refills","Refill if pharmacist approves"]],
  ["Schedule III–V refills (typical federal rule):", "Up to 5 refills within 6 months", ["Unlimited refills","No refills allowed","Exactly 2 refills"]],
  ["HIPAA primarily protects:", "Patient health information privacy", ["Drug pricing rules","DEA scheduling","NDC formatting"]],
  ["HIPAA 'minimum necessary' means:", "Only disclose PHI needed for the task", ["Always disclose entire profile","Never disclose any PHI","Only pharmacists can see PHI"]],
  ["DSCSA primarily relates to:", "Drug supply chain security/traceability", ["Only controlled diversion","Insurance formularies","Patient counseling"]],
  ["Refill too soon rejection: best first step:", "Verify last fill date and days supply", ["Override immediately","Dispense without billing","Change drug without prescriber"]],
  ["Prior authorization (PA) is typically required when:", "Plan requires approval before coverage", ["Patient wants cash price","Printer is down","NDC is missing"]],
  ["Common federal record retention minimum (baseline):", "2 years", ["6 months","1 year","10 years"]],
  ["Pseudoephedrine controls mainly address:", "Methamphetamine diversion prevention", ["CLIA regs","REMS programs","OSHA standards"]]
];

const CONVERSION_FACTS = [
  {q:"1 g equals:", a:"1000 mg", why:"1 gram = 1000 milligrams."},
  {q:"1 mg equals:", a:"1000 mcg", why:"1 milligram = 1000 micrograms."},
  {q:"1 tsp equals:", a:"5 mL", why:"1 teaspoon = 5 mL."},
  {q:"1 tbsp equals:", a:"15 mL", why:"1 tablespoon = 15 mL."},
  {q:"30 mL is about:", a:"1 fl oz", why:"30 mL ≈ 1 fluid ounce."},
  {q:"kg conversion rule:", a:"kg = lb ÷ 2.2", why:"Convert lb to kg by dividing by 2.2."}
];

/* ================= QUESTION GENERATORS ================= */
function makeQuestion(domain, stem, correct, wrongs, why){
  const pool = uniqBy(wrongs.filter(x=>x && x.toLowerCase()!==correct.toLowerCase()), x=>x.toLowerCase());
  if(pool.length < 3){
    // emergency filler (rare)
    while(pool.length<3) pool.push("None of the above");
  }
  const choices = [correct, pool[0], pool[1], pool[2]]; // correct always index 0 (simplifies scoring)
  return { domain, stem, choices, answer:0, why: why || "" };
}

function genMedQuestions(){
  const allBrands = uniqBy(MEDS.flatMap(m=>m.b), x=>x.toLowerCase());
  const allGens   = uniqBy(MEDS.map(m=>m.g), x=>x.toLowerCase());
  const allCls    = uniqBy(MEDS.map(m=>m.cls), x=>x.toLowerCase());
  const allInd    = uniqBy(MEDS.map(m=>m.ind), x=>x.toLowerCase());

  const out=[];
  for(const m of MEDS){
    const b = pick(m.b);
    out.push(makeQuestion(DOMAIN.MEDS, `Which brand name corresponds to the generic <b>${m.g}</b>?`, b,
      shuffle(allBrands.filter(x=>!m.b.map(y=>y.toLowerCase()).includes(x.toLowerCase()))).slice(0,6),
      `${m.g} is commonly associated with brand(s): ${m.b.join(", ")}.`
    ));
    for(const brand of m.b){
      out.push(makeQuestion(DOMAIN.MEDS, `Which generic corresponds to the brand <b>${brand}</b>?`, m.g,
        shuffle(allGens.filter(x=>x.toLowerCase()!==m.g.toLowerCase())).slice(0,6),
        `${brand} corresponds to ${m.g}.`
      ));
    }
    out.push(makeQuestion(DOMAIN.MEDS, `A common indication for <b>${m.g}</b> is:`, m.ind,
      shuffle(allInd.filter(x=>x.toLowerCase()!==m.ind.toLowerCase())).slice(0,6),
      `${m.g} is commonly used for ${m.ind}.`
    ));
    out.push(makeQuestion(DOMAIN.MEDS, `<b>${m.g}</b> is best classified as a(n):`, m.cls,
      shuffle(allCls.filter(x=>x.toLowerCase()!==m.cls.toLowerCase())).slice(0,6),
      `${m.g} is a ${m.cls}.`
    ));
  }

  // suffix pattern questions
  for(const r of SUFFIX_RULES){
    out.push(makeQuestion(DOMAIN.MEDS, `Which suffix most commonly suggests <b>${r.cls}</b>?`, r.suffix,
      shuffle(SUFFIX_RULES.filter(x=>x.suffix!==r.suffix).map(x=>x.suffix)),
      `Common naming pattern: ${r.cls} often ends in ${r.suffix}.`
    ));
  }

  // a few extra "most likely" med safety concepts
  out.push({domain:DOMAIN.MEDS, stem:"Which medication is commonly treated as a high-alert medication due to risk of severe harm if misused?", choices:["Insulin","Docusate","Loratadine","Mupirocin topical"], answer:0, why:"Insulin errors can cause severe hypo/hyperglycemia."});
  out.push({domain:DOMAIN.MEDS, stem:"Warfarin has increased bleeding risk when combined with:", choices:["NSAIDs","Calcium carbonate","Vitamin C","Melatonin"], answer:0, why:"NSAIDs can increase bleeding risk."});

  return out;
}

function genSafetyQuestions(){
  const out=[];
  for(const q of SAFETY_BANK){
    out.push({domain:DOMAIN.SAFETY, stem:q[0], choices:[q[1], q[2][0], q[2][1], q[2][2]], answer:0, why:""});
  }
  // Add USP mapping variations
  const uspMap = [
    ["Which USP chapter is most associated with sterile compounding?", "USP <797>", ["USP <795>","USP <800>","USP <700>"], "USP 797 is sterile compounding."],
    ["Which USP chapter is most associated with non-sterile compounding?", "USP <795>", ["USP <797>","USP <800>","USP <700>"], "USP 795 is non-sterile compounding."],
    ["Which USP chapter is most associated with hazardous drugs?", "USP <800>", ["USP <795>","USP <797>","USP <700>"], "USP 800 covers hazardous drugs."],
  ];
  for(const x of uspMap){
    out.push({domain:DOMAIN.SAFETY, stem:x[0], choices:[x[1],x[2][0],x[2][1],x[2][2]], answer:0, why:x[3]});
  }
  return out;
}

function genFederalQuestions(){
  const out=[];
  for(const q of FEDERAL_BANK){
    out.push({domain:DOMAIN.FED, stem:q[0], choices:[q[1], q[2][0], q[2][1], q[2][2]], answer:0, why:""});
  }
  return out;
}

function genOrderMathQuestions(){
  const out=[];

  // conversions (literal)
  for(const c of CONVERSION_FACTS){
    const wrongPool = ["10 mg","100 mg","1 mg","10 mcg","100 mcg","1 mcg","1 mL","10 mL","30 mL","2 fl oz","0.5 fl oz","kg = lb × 2.2","kg = lb ÷ 2.2","1 oz","8 mL"];
    out.push(makeQuestion(DOMAIN.ORDER, c.q, c.a, shuffle(wrongPool).slice(0,6), c.why));
  }

  // scenario generators (lots of variety)
  function genPedsMgKg(){
    const lb = pick([22,33,44,55,66,77,88]);
    const kg = Math.round(lb/2.2);
    const mgkg = pick([5,10,15,20,25]);
    const doses = pick([2,3,4]);
    const daily = kg*mgkg;
    const perDose = Math.round(daily/doses);
    const stem = `Scenario: Child weighs <b>${lb} lb</b> (round to nearest kg). Rx: <b>${mgkg} mg/kg/day</b> divided <b>${doses} doses/day</b>. What is <b>mg per dose</b>?`;
    const correct = `${perDose} mg per dose`;
    const wrong = [`${daily} mg per dose`, `${Math.round(perDose/2)} mg per dose`, `${perDose*2} mg per dose`, `${kg} mg per dose`];
    return makeQuestion(DOMAIN.ORDER, stem, correct, wrong, `${lb} lb ÷ 2.2 ≈ ${kg} kg. Daily=${kg}×${mgkg}=${daily} mg/day. Per dose=${daily}÷${doses}=${perDose}.`);
  }

  function genDaysSupply(){
    const perDay = pick([1,2,3,4]);
    const days = pick([7,10,14,30]);
    const qty = perDay*days;
    const freq = perDay===1?"once daily":perDay===2?"BID":perDay===3?"TID":"QID";
    const stem = `Rx: Take 1 tablet <b>${freq}</b> for <b>${days} days</b>. What quantity is needed?`;
    const correct = `${qty} tablets`;
    const wrong = [`${days} tablets`, `${qty+perDay} tablets`, `${qty-perDay} tablets`, `${qty*2} tablets`];
    return makeQuestion(DOMAIN.ORDER, stem, correct, wrong, `Qty = doses/day (${perDay}) × days (${days}) = ${qty}.`);
  }

  function genIVRate(){
    const vol = pick([250,500,750,1000,1250]);
    const hrs = pick([2,4,6,8,10]);
    const rate = Math.round(vol/hrs);
    const stem = `IV infusion: <b>${vol} mL</b> over <b>${hrs} hours</b>. What is the rate (mL/hr)?`;
    const correct = `${rate} mL/hr`;
    const wrong = [`${vol} mL/hr`, `${hrs} mL/hr`, `${Math.round(rate*1.25)} mL/hr`, `${Math.round(rate*0.75)} mL/hr`];
    return makeQuestion(DOMAIN.ORDER, stem, correct, wrong, `Rate = ${vol} ÷ ${hrs} ≈ ${rate} mL/hr (rounded).`);
  }

  function genPercentWV(){
    const pct = pick([0.5,1,2,5,10]);
    const vol = pick([50,100,250,500]);
    const grams = Math.round(((pct/100)*vol)*1000)/1000;
    const stem = `A solution labeled <b>${pct}% w/v</b> contains how many grams of drug in <b>${vol} mL</b>?`;
    const correct = `${grams} g`;
    const wrong = [`${grams*10} g`, `${Math.round((grams/10)*1000)/1000} g`, `${pct} g`, `${vol} g`];
    return makeQuestion(DOMAIN.ORDER, stem, correct, wrong, `% w/v = grams per 100 mL. ${pct} g/100 mL × ${vol}/100 = ${grams} g.`);
  }

  // workflow literals
  out.push({domain:DOMAIN.ORDER, stem:"A DAW code generally relates to:", choices:["Dispense As Written / substitution instructions","Drug assay weight","Dose after withdrawal","DEA audit window"], answer:0, why:"DAW indicates substitution instructions."});
  out.push({domain:DOMAIN.ORDER, stem:"Insurance reject: 'Refill too soon.' Best first step:", choices:["Verify last fill date, days supply, and entry accuracy","Override immediately","Dispense without billing","Change drug without prescriber"], answer:0, why:"Verify timing/data first."});
  out.push({domain:DOMAIN.ORDER, stem:"Alligation is commonly used to calculate:", choices:["Mixture proportions to reach a target strength","Days supply for inhalers","NDC selection","DEA schedule"], answer:0, why:"Alligation finds mixture proportions."});
  out.push({domain:DOMAIN.ORDER, stem:"A levigating agent is used to:", choices:["Help form a smooth paste when incorporating powders","Sterilize a product","Increase pH rapidly","Increase controlled substance security"], answer:0, why:"Levigating agents help incorporate powders."});

  // generate a bunch
  for(let i=0;i<120;i++){
    const r=Math.random();
    if(r<0.30) out.push(genPedsMgKg());
    else if(r<0.58) out.push(genDaysSupply());
    else if(r<0.78) out.push(genIVRate());
    else out.push(genPercentWV());
  }

  return out;
}

/* ================= BUILD EXAM (WEIGHTED 90) ================= */
async function buildExam(useRxNav){
  statusEl.textContent = "Building practice test…";
  const medsPool = genMedQuestions();
  const safetyPool = genSafetyQuestions();
  const orderPool = genOrderMathQuestions();
  const fedPool = genFederalQuestions();

  let rxAdds = [];
  if(useRxNav){
    statusEl.textContent = "RxNav enabled — fetching a few extra medication pairs (optional)…";
    try{
      const seeds = shuffle(RX_SEEDS.slice()).slice(0,12);
      const allBrands = uniqBy(MEDS.flatMap(m=>m.b), x=>x.toLowerCase());
      for(const ing of seeds){
        const brands = await withTimeout((signal)=>rxnavBrandsForIngredient(ing, signal), 6500).catch(()=>[]);
        if(brands && brands.length){
          const brand = pick(brands.slice(0,12));
          const wrong = shuffle(allBrands.filter(x=>x.toLowerCase()!==brand.toLowerCase())).slice(0,6);
          rxAdds.push(makeQuestion(DOMAIN.MEDS, `(RxNav) Which brand corresponds to the generic <b>${ing}</b>?`, brand, wrong,
            "Generated via RxNav/RxNorm lookup."
          ));
        }
        if(rxAdds.length>=10) break;
      }
    }catch(e){
      rxAdds = [];
    }
  }

  // Merge pools (meds gets rx adds)
  const medsMerged = uniqBy(rxAdds.concat(medsPool), q=>q.stem + "||" + q.choices[0]);

  const pickN = (pool, n) => shuffle(pool.slice()).slice(0,n);

  const assembled = []
    .concat(pickN(medsMerged, COUNTS.MEDS))
    .concat(pickN(safetyPool, COUNTS.SAFETY))
    .concat(pickN(orderPool, COUNTS.ORDER))
    .concat(pickN(fedPool, COUNTS.FED));

  // Safety: ensure exactly 90
  questions = assembled.slice(0,TOTAL);

  // Optional shuffle questions
  const doShuffleQ = document.getElementById("optShuffleQ").checked;
  if(doShuffleQ) shuffle(questions);

  statusEl.textContent = "";
}

/* ================= TIMER ================= */
function startTimer(){
  stopTimer();
  document.getElementById("timerPill").style.display = timed ? "" : "none";
  document.getElementById("timerText").textContent = fmtTime(timeLeft);
  if(!timed) return;

  timer = setInterval(()=>{
    timeLeft--;
    document.getElementById("timerText").textContent = fmtTime(Math.max(0,timeLeft));
    if(timeLeft<=0){
      stopTimer();
      submitTest(true);
    }
  },1000);
}
function stopTimer(){
  if(timer){ clearInterval(timer); timer=null; }
}

/* ================= UI FLOW ================= */
function goHome(){
  stopTimer();
  document.getElementById("home").style.display="";
  document.getElementById("test").style.display="none";
  document.getElementById("flashHome").style.display="none";
  document.getElementById("flash").style.display="none";
  statusEl.textContent="";
}
function goFlashHome(){
  stopTimer();
  document.getElementById("home").style.display="none";
  document.getElementById("test").style.display="none";
  document.getElementById("flashHome").style.display="";
  document.getElementById("flash").style.display="none";
}

/* ================= TEST FLOW ================= */
async function startTest(){
  document.getElementById("home").style.display="none";
  document.getElementById("flashHome").style.display="none";
  document.getElementById("flash").style.display="none";
  document.getElementById("test").style.display="";

  // options
  timed = document.getElementById("optTimed").checked;
  timeLeft = 110*60;
  const useRxNav = document.getElementById("optRxNav").checked;

  // build
  document.getElementById("question").textContent="Loading questions…";
  document.getElementById("choices").innerHTML="";
  document.getElementById("nav").innerHTML="";
  answers = new Map();
  flags = new Set();
  index = 0;

  await buildExam(useRxNav);
  startTimer();
  renderQ();
}

function renderTopStats(){
  document.getElementById("qNum").textContent = String(index+1);
  document.getElementById("answeredCount").textContent = String(answers.size);
  document.getElementById("flaggedCount").textContent = String(flags.size);
  document.getElementById("domainPill").textContent = questions[index]?.domain || "—";
}

function renderQ(){
  const q = questions[index];
  renderTopStats();
  document.getElementById("question").innerHTML = q.stem;

  const selected = answers.get(index);
  const wrap = q.choices.map((c,i)=>{
    const checked = (selected===i) ? "checked" : "";
    return `
      <div class="choice">
        <label style="cursor:pointer;">
          <input type="radio" name="c" ${checked}
            onchange="selectAnswer(${index},${i})">
          ${c}
        </label>
      </div>
    `;
  }).join("");
  document.getElementById("choices").innerHTML = wrap;

  renderNav();
}

function selectAnswer(qIndex, choiceIndex){
  // index-based answers (fixes any “shared answer” bug)
  answers.set(qIndex, choiceIndex);
  renderTopStats();
  renderNav();
}

function renderNav(){
  const nav = questions.map((_,i)=>{
    const cls = [
      "navbtn",
      answers.has(i) ? "answered" : "",
      flags.has(i) ? "flagged" : "",
      i===index ? "current" : ""
    ].join(" ");
    return `<div class="${cls}" onclick="gotoQ(${i})">${i+1}</div>`;
  }).join("");
  document.getElementById("nav").innerHTML = nav;
}

function gotoQ(i){ index=i; renderQ(); }
function nextQ(){ if(index<89){ index++; renderQ(); } }
function prevQ(){ if(index>0){ index--; renderQ(); } }

function flagQ(){
  if(flags.has(index)) flags.delete(index);
  else flags.add(index);
  renderTopStats();
  renderNav();
}
function clearQ(){
  answers.delete(index);
  renderTopStats();
  renderNav();
  renderQ();
}

function submitTest(fromTimer){
  stopTimer();
  let correct=0, incorrect=0, blank=0;

  for(let i=0;i<questions.length;i++){
    const q=questions[i];
    const a=answers.get(i);
    if(a===undefined){ blank++; continue; }
    if(a===q.answer) correct++;
    else incorrect++;
  }

  const pct = Math.round((correct/TOTAL)*100);
  alert(`${fromTimer ? "Time is up.\n\n" : ""}Score: ${correct}/90 (${pct}%)\nIncorrect: ${incorrect}\nBlank: ${blank}`);
}

/* ================= FLASHCARDS (DECK SELECT + VIEW) ================= */
let flashDeck = [];
let flashDeckName = "";
let fIndex = 0;
let fFront = true;

function buildFlashDeck(type){
  // Build a big card set from the same concepts (and keep it sectioned)
  const cards = [];

  // MED cards
  for(const m of MEDS){
    cards.push({deck:"MEDS", front:`Brand for: ${m.g}`, back:m.b.join(", ")});
    for(const b of m.b) cards.push({deck:"MEDS", front:`Generic for: ${b}`, back:m.g});
    cards.push({deck:"MEDS", front:`Class: ${m.g}`, back:m.cls});
    cards.push({deck:"MEDS", front:`Use: ${m.g}`, back:m.ind});
  }
  for(const r of SUFFIX_RULES){
    cards.push({deck:"MEDS", front:`Suffix ${r.suffix} suggests`, back:r.cls});
    cards.push({deck:"MEDS", front:`Class ${r.cls} suggests suffix`, back:r.suffix});
  }

  // SAFETY cards
  cards.push({deck:"SAFETY", front:"USP <795>", back:"Non-sterile compounding"});
  cards.push({deck:"SAFETY", front:"USP <797>", back:"Sterile compounding"});
  cards.push({deck:"SAFETY", front:"USP <800>", back:"Hazardous drug handling safety"});
  cards.push({deck:"SAFETY", front:"Garbing first step", back:"Hand hygiene"});
  cards.push({deck:"SAFETY", front:"LASA", back:"Look-alike / sound-alike"});
  cards.push({deck:"SAFETY", front:"Leading zero", back:"Use 0.5 (not .5)"});
  cards.push({deck:"SAFETY", front:"Trailing zero", back:"Avoid 5.0; write 5"});
  cards.push({deck:"SAFETY", front:"High osmolarity TPN typically requires", back:"Central venous access"});

  // ORDER/Math cards
  for(const c of CONVERSION_FACTS){
    cards.push({deck:"ORDER", front:c.q, back:c.a});
  }
  cards.push({deck:"ORDER", front:"% w/v means", back:"grams per 100 mL"});
  cards.push({deck:"ORDER", front:"Refill too soon: first step", back:"Verify last fill and days supply"});
  cards.push({deck:"ORDER", front:"Alligation used for", back:"mixture proportions to target strength"});
  cards.push({deck:"ORDER", front:"Levigating agent purpose", back:"smooth paste to incorporate powders"});

  // FED cards
  cards.push({deck:"FED", front:"DEA Form 222", back:"Ordering Schedule II controlled substances"});
  cards.push({deck:"FED", front:"DEA Form 106", back:"Report theft/significant loss of controlled substances"});
  cards.push({deck:"FED", front:"DEA Form 41", back:"Controlled substance destruction documentation (as applicable)"});
  cards.push({deck:"FED", front:"CII refills", back:"No refills allowed federally"});
  cards.push({deck:"FED", front:"CIII–V refills", back:"Up to 5 refills within 6 months (typical federal rule)"});
  cards.push({deck:"FED", front:"HIPAA protects", back:"Patient health information privacy"});
  cards.push({deck:"FED", front:"Minimum necessary", back:"Only disclose PHI needed for the task"});
  cards.push({deck:"FED", front:"DSCSA", back:"Supply chain security/traceability"});

  let deck;
  if(type==="MIXED") deck = cards;
  else deck = cards.filter(c=>c.deck===type);

  // Shuffle for variety
  flashDeck = shuffle(deck.slice());
  flashDeckName = type==="MEDS" ? "Medications" :
                  type==="SAFETY" ? "Patient Safety" :
                  type==="ORDER" ? "Order Entry / Math" :
                  type==="FED" ? "Federal" : "Mixed";
  fIndex = 0;
  fFront = true;
}

function openFlash(type){
  document.getElementById("home").style.display="none";
  document.getElementById("test").style.display="none";
  document.getElementById("flashHome").style.display="none";
  document.getElementById("flash").style.display="";

  buildFlashDeck(type);

  document.getElementById("flashDeckName").textContent = flashDeckName;
  renderFlash();
}

function renderFlash(){
  const total = Math.max(1, flashDeck.length);
  const card = flashDeck[fIndex] || {front:"No cards", back:"—"};
  document.getElementById("flashPos").textContent = String(fIndex+1);
  document.getElementById("flashTotal").textContent = String(total);
  document.getElementById("flashSide").textContent = fFront ? "Front" : "Back";
  document.getElementById("flashCard").textContent = fFront ? card.front : card.back;
}

document.getElementById("flashCard").onclick = ()=>{
  fFront = !fFront;
  renderFlash();
};

function nextFlash(){
  if(!flashDeck.length){ return; }
  fIndex = (fIndex + 1) % flashDeck.length;
  fFront = true;
  renderFlash();
}

/* init */
goHome();
</script>

</body>
</html>
