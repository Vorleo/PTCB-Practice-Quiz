<!doctype html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PTCB Practice Exam (2026-Weighted • 90 Questions)</title>
  <meta name="description" content="PTCB/PTCE-style practice exam: 90 questions, 4 options, 110-minute timer, learning weighting, dark/light mode, RxNav dynamic meds, realistic workflows + math." />

  <style>
    /* ========= Theme tokens ========= */
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted: #4b5563;
      --border: #e5e7eb;
      --shadow: 0 6px 20px rgba(0,0,0,.06);

      --header-bg: #111827;
      --header-text: #ffffff;

      --pill-bg: #f3f4f6;
      --pill-text: #111827;

      --primary: #111827;
      --primary-text: #ffffff;

      --secondary: #e5e7eb;
      --secondary-text: #111827;

      --danger: #b91c1c;
      --danger-text: #ffffff;

      --accent: #2563eb;

      --tag-bg: #eef2ff;
      --tag-text: #1e3a8a;

      --ok-bg: #ecfdf5;
      --ok-border: #a7f3d0;
      --ok-text: #065f46;

      --note-bg: #fefce8;
      --note-border: #fde68a;
      --note-text: #713f12;

      --warn-bg: #fff7ed;
      --warn-border: #fed7aa;
      --warn-text: #9a3412;

      --choice-hover: #f9fafb;
      --choice-selected: #eff6ff;
    }

    html[data-theme="dark"]{
      --bg: #0b1020;
      --card: #0f172a;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #243047;
      --shadow: 0 10px 28px rgba(0,0,0,.45);

      --header-bg: #0a0f1e;
      --header-text: #e5e7eb;

      --pill-bg: #111b33;
      --pill-text: #e5e7eb;

      --primary: #2563eb;
      --primary-text: #ffffff;

      --secondary: #1f2a44;
      --secondary-text: #e5e7eb;

      --danger: #ef4444;
      --danger-text: #111827;

      --accent: #60a5fa;

      --tag-bg: #111b33;
      --tag-text: #bfdbfe;

      --ok-bg: #06291f;
      --ok-border: #0f4d3a;
      --ok-text: #86efac;

      --note-bg: #2b2206;
      --note-border: #6b4f00;
      --note-text: #fde68a;

      --warn-bg: #2b1508;
      --warn-border: #7c2d12;
      --warn-text: #fdba74;

      --choice-hover: #111b33;
      --choice-selected: #0b2a55;
    }

    /* ========= Base layout ========= */
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--text); }
    body { margin: 0; background: var(--bg); }

    header { background: var(--header-bg); color: var(--header-text); padding: 16px 18px; }
    header h1 { margin: 0; font-size: 18px; }
    header p { margin: 6px 0 0; font-size: 13px; opacity: .92; }

    .headerRow{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      max-width: 980px; margin: 0 auto;
    }

    .themeControls{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
    }

    .wrap { max-width: 980px; margin: 18px auto; padding: 0 14px; }
    .card { background: var(--card); border-radius: 14px; box-shadow: var(--shadow); padding: 16px; border: 1px solid rgba(0,0,0,0); }
    html[data-theme="dark"] .card { border-color: var(--border); }

    .grid { display: grid; grid-template-columns: 1.2fr .8fr; gap: 14px; align-items: start; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .muted { color: var(--muted); }
    .tiny { font-size: 12px; }

    .pill { display:inline-flex; gap:8px; align-items:center; padding: 6px 10px; background: var(--pill-bg); color: var(--pill-text); border-radius: 999px; font-size: 12px; border: 1px solid var(--border); }
    .pill b { font-weight: 800; }

    .progress { height: 10px; background: var(--border); border-radius:999px; overflow:hidden; }
    .bar { height: 100%; background: var(--accent); width:0%; transition: width .2s ease; }

    button {
      border: 0; border-radius: 10px; padding: 10px 12px; cursor: pointer;
      background: var(--primary); color: var(--primary-text); font-weight: 700;
    }
    button.secondary { background: var(--secondary); color: var(--secondary-text); }
    button.warn { background: var(--danger); color: var(--danger-text); }
    button:disabled { opacity:.5; cursor:not-allowed; }

    .qhead { display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .qtitle { font-size: 16px; margin: 0 0 6px; }
    .domainTag { font-size: 12px; padding: 5px 10px; border-radius: 999px; background: var(--tag-bg); color: var(--tag-text); white-space: nowrap; border: 1px solid var(--border); }
    .stem { margin: 8px 0 12px; line-height: 1.35; }
    .choices { display:grid; gap: 10px; }

    label.choice {
      display:flex; gap:10px; align-items:flex-start;
      padding: 12px; border: 1px solid var(--border); border-radius: 12px; cursor:pointer;
      transition: background .12s ease, border-color .12s ease;
      background: rgba(0,0,0,0);
    }
    label.choice:hover { background: var(--choice-hover); }
    label.choice.selected { background: var(--choice-selected); border-color: var(--accent); }
    input[type="radio"] { margin-top: 3px; }

    .rightPane .card { position: sticky; top: 14px; }
    .navgrid { display:grid; grid-template-columns: repeat(10, 1fr); gap: 6px; margin-top: 10px; }
    .navbtn {
      width: 100%; padding: 8px 0; border-radius: 10px; border: 1px solid var(--border);
      background: var(--card); color: var(--text); font-weight:700; cursor:pointer; font-size: 12px;
    }
    .navbtn.answered { background: rgba(16,185,129,.18); border-color: rgba(16,185,129,.35); }
    .navbtn.flagged { background: rgba(245,158,11,.18); border-color: rgba(245,158,11,.35); }
    .navbtn.current { outline: 2px solid var(--accent); border-color: var(--accent); }

    .hr { height:1px; background: var(--border); margin: 12px 0; }
    .reviewItem { border:1px solid var(--border); border-radius: 12px; padding: 12px; margin-bottom: 10px; }
    .correct { color:#10b981; font-weight: 800; }
    .incorrect { color:#ef4444; font-weight: 800; }
    .explain { background: rgba(127,127,127,.10); border-radius: 10px; padding: 10px; margin-top: 8px; color: var(--text); border: 1px solid var(--border); }

    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; background: var(--primary); color: var(--primary-text); padding: 3px 6px; border-radius: 6px; }
    .note { background: var(--note-bg); border: 1px solid var(--note-border); color: var(--note-text); padding: 10px 12px; border-radius: 12px; }
    .ok { background: var(--ok-bg); border:1px solid var(--ok-border); color: var(--ok-text); padding: 10px 12px; border-radius: 12px; }
    .warnbox { background: var(--warn-bg); border:1px solid var(--warn-border); color: var(--warn-text); padding: 10px 12px; border-radius: 12px; }

    select{
      border:1px solid var(--border);
      background: var(--card);
      color: var(--text);
      border-radius: 10px;
      padding: 9px 10px;
      font-weight: 700;
    }

    @media (max-width: 900px){
      .grid { grid-template-columns: 1fr; }
      .rightPane .card { position: static; }
      .headerRow{ flex-direction:column; align-items:flex-start; }
      .themeControls{ justify-content:flex-start; }
    }
    @media (max-width: 520px){
      header { padding: 14px 14px; }
      .wrap { padding: 0 10px; }
      .navgrid { grid-template-columns: repeat(8, 1fr); }
      button { padding: 12px 12px; }
      label.choice { padding: 14px; }
      .pill { font-size: 11px; }
    }
  </style>
</head>
<body>
<header>
  <div class="headerRow">
    <div>
      <h1>PTCB Practice Exam — 2026 Weighting • 90 Questions</h1>
      <p>90 questions • 4 options • Timed 110 minutes (optional) • Learning mode • Dark/Light mode • RxNav dynamic meds</p>
    </div>

    <div class="themeControls">
      <span class="pill">Theme</span>
      <button id="themeAutoBtn" class="secondary" title="Follow your device theme">Auto</button>
      <button id="themeLightBtn" class="secondary">Light</button>
      <button id="themeDarkBtn" class="secondary">Dark</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div id="startScreen" class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <h2 style="margin:0 0 6px">Start</h2>
        <div class="muted tiny">
          2026 domain weighting:
          <b>Medications 35%</b>, <b>Federal 18.75%</b>, <b>Safety 23.75%</b>, <b>Order Entry 22.50%</b>.
          (This practice exam uses whole-question rounding: 32/17/21/20.)
        </div>
      </div>
      <div class="pill"><b>90</b> questions • <b>4</b> options</div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <label class="pill" style="cursor:pointer">
        <input id="shuffleQ" type="checkbox" checked />
        Shuffle questions
      </label>
      <label class="pill" style="cursor:pointer">
        <input id="shuffleA" type="checkbox" checked />
        Shuffle answer choices
      </label>

      <label class="pill" style="cursor:pointer">
        <input id="timed" type="checkbox" />
        Timed
      </label>

      <label class="pill" style="cursor:pointer">
        Timer length
        <select id="timerLen">
          <option value="110" selected>110 min (PTCE)</option>
          <option value="90">90 min</option>
          <option value="120">120 min</option>
        </select>
      </label>

      <label class="pill" style="cursor:pointer">
        <input id="useOnlineMeds" type="checkbox" checked />
        Use online meds (RxNav)
      </label>

      <label class="pill" style="cursor:pointer">
        <input id="learningMode" type="checkbox" checked />
        Learning mode (missed more often)
      </label>
    </div>

    <div class="hr"></div>

    <div class="note tiny">
      You can <b>submit anytime</b> after the exam is built — unanswered questions count as unanswered (not wrong).
      Keyboard: <span class="kbd">←</span>/<span class="kbd">→</span> prev/next.
    </div>

    <div id="statusBox" class="ok tiny" style="margin-top:12px; display:none;"></div>

    <div class="row" style="margin-top:12px">
      <button id="startBtn">Start Exam</button>
      <button id="resetBtn" class="secondary">Reset</button>
      <button id="wipeStatsBtn" class="secondary" title="Clears learning history (localStorage)">
        Clear Learning History
      </button>
    </div>

    <div class="hr"></div>
    <div class="muted tiny">
      Note: This is a study tool — not official PTCB content. Dynamic medication brand/generic mappings use RxNav/RxNorm when enabled.
    </div>
  </div>

  <div id="examScreen" style="display:none" class="grid">
    <div class="leftPane">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <span class="pill">Q <b id="qCounter">1</b>/90</span>
            <span class="pill">Total: <b id="totalQ">90</b></span>
            <span class="pill">Answered: <b id="answeredCount">0</b></span>
            <span class="pill">Flagged: <b id="flagCount">0</b></span>
          </div>
          <div class="row">
            <span id="timerPill" class="pill" style="display:none">Time left: <b id="timeLeft">110:00</b></span>
            <!-- Submit is ALWAYS allowed after build (even with 0 answered) -->
            <button id="submitBtn" class="warn" disabled>Submit</button>
          </div>
        </div>

        <div style="margin:12px 0">
          <div class="progress"><div id="progressBar" class="bar"></div></div>
          <div class="tiny muted" style="margin-top:6px">Progress tracks how many you answered.</div>
        </div>

        <div class="hr"></div>

        <div class="qhead">
          <div>
            <h3 id="qTitle" class="qtitle">Question</h3>
            <div id="qMeta" class="tiny muted"></div>
          </div>
          <div id="domainTag" class="domainTag">Domain</div>
        </div>

        <div id="qStem" class="stem"></div>
        <div id="choices" class="choices"></div>

        <div class="hr"></div>

        <div class="row" style="justify-content:space-between">
          <div class="row">
            <button id="prevBtn" class="secondary">← Prev</button>
            <button id="nextBtn">Next →</button>
          </div>
          <div class="row">
            <button id="flagBtn" class="secondary">Flag</button>
            <button id="clearBtn" class="secondary">Clear Answer</button>
          </div>
        </div>
      </div>
    </div>

    <div class="rightPane">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">Navigator</h3>
          <button id="endBtn" class="secondary">Exit</button>
        </div>
        <div class="tiny muted" style="margin-top:6px">
          Green = answered • Orange = flagged • Blue outline = current
        </div>
        <div id="navGrid" class="navgrid"></div>
      </div>
    </div>
  </div>

  <div id="resultsScreen" style="display:none" class="card">
    <div class="row" style="justify-content:space-between; align-items:flex-start">
      <div>
        <h2 style="margin:0 0 6px">Results</h2>
        <div class="muted tiny">Practice scoring + review. (Not official.)</div>
      </div>
      <div class="row">
        <button id="restartBtn">Restart</button>
        <button id="backHomeBtn" class="secondary">Home</button>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <div class="pill">Overall: <b id="overallScore">0%</b></div>
      <div class="pill">Correct: <b id="correctCount">0</b></div>
      <div class="pill">Incorrect: <b id="incorrectCount">0</b></div>
      <div class="pill">Unanswered: <b id="unansweredCount">0</b></div>
    </div>

    <div class="hr"></div>

    <h3 style="margin:0 0 8px">Domain Breakdown</h3>
    <div id="domainBreakdown" class="row" style="gap:8px"></div>

    <div class="hr"></div>

    <h3 style="margin:0 0 8px">Review</h3>
    <div id="reviewList"></div>
  </div>
</div>

<script>
/* =========================
   Theme
========================= */
const THEME_KEY = "ptcb_theme_pref_v1";
function applyTheme(mode){
  const html = document.documentElement;
  if(mode === "auto"){
    html.setAttribute("data-theme","auto");
    const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    html.setAttribute("data-theme", prefersDark ? "dark" : "light");
    localStorage.setItem(THEME_KEY, "auto");
    return;
  }
  html.setAttribute("data-theme", mode);
  localStorage.setItem(THEME_KEY, mode);
}
function loadTheme(){
  const saved = localStorage.getItem(THEME_KEY) || "auto";
  if(saved === "auto"){
    applyTheme("auto");
  } else {
    applyTheme(saved);
  }
}
document.getElementById("themeAutoBtn").addEventListener("click", ()=>applyTheme("auto"));
document.getElementById("themeLightBtn").addEventListener("click", ()=>applyTheme("light"));
document.getElementById("themeDarkBtn").addEventListener("click", ()=>applyTheme("dark"));
loadTheme();

/* =========================
   Core configuration (2026 weights)
========================= */

const TOTAL_QUESTIONS = 90;

// 2026 PTCE content outline (effective Jan 6, 2026):
// Medications 35%
// Federal 18.75%
// Safety 23.75%
// Order Entry 22.50%
// We map to integer counts that sum to 90: 32, 17, 21, 20.
const DOMAIN = {
  MEDS: "Medications",
  FED: "Federal Requirements",
  SAFETY: "Patient Safety & Quality Assurance",
  ORDER: "Order Entry & Processing"
};

const COUNTS = {
  [DOMAIN.MEDS]: 32,
  [DOMAIN.FED]: 17,
  [DOMAIN.SAFETY]: 21,
  [DOMAIN.ORDER]: 20
};

function shuffle(arr){
  for (let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function fmtTime(sec){
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return `${m}:${String(s).padStart(2,'0')}`;
}
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

/* =========================
   Learning stats (local)
========================= */

const STATS_KEY = "ptcb_q_stats_v7";
function loadStats(){ try { return JSON.parse(localStorage.getItem(STATS_KEY) || "{}"); } catch { return {}; } }
function saveStats(stats){ localStorage.setItem(STATS_KEY, JSON.stringify(stats)); }
function wipeStats(){ localStorage.removeItem(STATS_KEY); }
function nowTs(){ return Date.now(); }

function weightForPick(qid, stats){
  const s = stats[qid] || { attempts:0, correct:0, lastSeen:0 };
  const attempts = s.attempts || 0;
  const correct = s.correct || 0;
  const wrong = Math.max(0, attempts - correct);

  const missFactor = (wrong + 1) / (attempts + 2);
  const ageMs = Math.max(0, nowTs() - (s.lastSeen || 0));
  const ageDays = ageMs / (1000*60*60*24);
  const recencyFactor = clamp(ageDays / 3.0, 0, 1);

  const base = 0.30;
  const w = base + (0.90 * missFactor) + (0.55 * recencyFactor);
  return Math.sqrt(w);
}

function weightedSampleNoReplace(items, count, weightFn){
  const pool = items.slice();
  const picked = [];
  while (picked.length < count && pool.length > 0){
    const weights = pool.map(weightFn);
    const total = weights.reduce((a,b)=>a+b,0);
    let r = Math.random() * total;
    let idx = 0;
    for (; idx < pool.length; idx++){
      r -= weights[idx];
      if (r <= 0) break;
    }
    const chosen = pool.splice(Math.min(idx, pool.length-1), 1)[0];
    picked.push(chosen);
  }
  return picked;
}
function randomSampleNoReplace(items, count){
  const s = shuffle(items.slice());
  return s.slice(0, Math.min(count, s.length));
}

/* =========================
   RxNav dynamic meds (optional)
========================= */

const RXNAV_BASE = "https://rxnav.nlm.nih.gov/REST";

const MED_SEEDS = [
  "lisinopril","losartan","valsartan","olmesartan","enalapril","benazepril","ramipril",
  "amlodipine","diltiazem","verapamil",
  "metoprolol","carvedilol","atenolol","propranolol",
  "hydrochlorothiazide","chlorthalidone","furosemide","spironolactone",
  "atorvastatin","rosuvastatin","simvastatin","pravastatin",
  "metformin","glipizide","glyburide","sitagliptin","empagliflozin",
  "insulin glargine","insulin lispro","insulin aspart",
  "levothyroxine",
  "omeprazole","pantoprazole","esomeprazole","lansoprazole",
  "sertraline","fluoxetine","citalopram","escitalopram","paroxetine",
  "duloxetine","venlafaxine","bupropion",
  "gabapentin","pregabalin",
  "amoxicillin","amoxicillin clavulanate","cephalexin","doxycycline","clindamycin","azithromycin",
  "sulfamethoxazole trimethoprim",
  "warfarin","apixaban","rivaroxaban","clopidogrel","aspirin",
  "albuterol","fluticasone","budesonide","montelukast",
  "tamsulosin","finasteride",
  "ondansetron","promethazine",
  "ibuprofen","naproxen","meloxicam",
  "tramadol","hydrocodone acetaminophen",
  "famotidine","cetirizine","loratadine",
  "sildenafil","tadalafil",
  "allopurinol","colchicine",
  "prednisone","valacyclovir","acyclovir","oseltamivir"
];

function withTimeout(promiseFactory, ms){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), ms);
  return { promise: promiseFactory(ctrl.signal).finally(()=>clearTimeout(t)), ctrl };
}
async function fetchJson(url, signal){
  const res = await fetch(url, { signal });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}
function extractBrandsFromDrugName(rxName){
  const matches = rxName.match(/\[([^\]]+)\]/g) || [];
  return matches.map(m => m.replace(/^\[/,'').replace(/\]$/,'').trim()).filter(Boolean);
}
async function rxnavBrandsForIngredient(ingredient, signal){
  const url = `${RXNAV_BASE}/drugs.json?name=${encodeURIComponent(ingredient)}`;
  const data = await fetchJson(url, signal);
  const groups = (data?.drugGroup?.conceptGroup) || [];
  const sbd = groups.find(g => g.tty === "SBD");
  const concepts = sbd?.conceptProperties || [];
  const brands = new Set();
  for(const c of concepts){
    const name = c?.name || "";
    for(const b of extractBrandsFromDrugName(name)) brands.add(b);
  }
  const bnGroup = groups.find(g => g.tty === "BN");
  const bnConcepts = bnGroup?.conceptProperties || [];
  for(const c of bnConcepts){
    if(c?.name) brands.add(c.name.trim());
  }
  return Array.from(brands);
}
function makeChoicesWithDistractors(correct, distractors){
  const wrongs = shuffle(distractors.filter(x => x && x.toLowerCase() !== correct.toLowerCase()));
  const pickedWrongs = [];
  for(const w of wrongs){
    if(pickedWrongs.length >= 3) break;
    if(!pickedWrongs.some(p => p.toLowerCase() === w.toLowerCase())) pickedWrongs.push(w);
  }
  if(pickedWrongs.length < 3) return null;
  const choices = shuffle([correct, ...pickedWrongs]);
  return { choices, answerIndex: choices.indexOf(correct) };
}
async function buildDynamicMedsQuestions(targetCount){
  // Keep dynamic meds a subset so local bank still provides variety.
  const desired = Math.min(targetCount, 24);
  const seeds = shuffle(MED_SEEDS.slice()).slice(0, 24);

  const ingredientToBrands = new Map();
  const concurrency = 5;
  let i = 0;

  async function worker(){
    while (i < seeds.length){
      const ing = seeds[i++];
      try{
        const { promise } = withTimeout((signal)=>rxnavBrandsForIngredient(ing, signal), 6500);
        const brands = await promise;
        if (brands && brands.length >= 1) ingredientToBrands.set(ing, brands.slice(0, 14));
      } catch(e){ /* ignore */ }
    }
  }
  await Promise.all(Array.from({length: concurrency}, worker));

  const allBrands = [];
  ingredientToBrands.forEach(brands => brands.forEach(b => allBrands.push(b)));
  const uniqBrands = Array.from(new Set(allBrands));
  shuffle(uniqBrands);

  const questions = [];
  for(const [ing, brands] of ingredientToBrands.entries()){
    if(questions.length >= desired) break;

    const correctBrand = brands[Math.floor(Math.random() * brands.length)];
    const combo1 = makeChoicesWithDistractors(correctBrand, uniqBrands);
    if(combo1){
      questions.push({
        id: `rxnav:gen2brand:${ing.toLowerCase()}:${correctBrand.toLowerCase()}`,
        domain: DOMAIN.MEDS,
        stem: `Which brand name corresponds to the generic medication <b>${ing}</b>?`,
        choices: combo1.choices,
        answerIndex: combo1.answerIndex,
        explanation: `Dynamic mapping from RxNav/RxNorm brand concepts.`,
        ref: "RxNav/RxNorm (dynamic)"
      });
    }
    if(questions.length >= desired) break;

    if(Math.random() < 0.75){
      const distractorGens = shuffle(MED_SEEDS.filter(x => x.toLowerCase() !== ing.toLowerCase())).slice(0, 16);
      const combo2 = makeChoicesWithDistractors(ing, distractorGens);
      if(combo2){
        questions.push({
          id: `rxnav:brand2gen:${correctBrand.toLowerCase()}:${ing.toLowerCase()}`,
          domain: DOMAIN.MEDS,
          stem: `Which generic medication corresponds to the brand name <b>${correctBrand}</b>?`,
          choices: combo2.choices,
          answerIndex: combo2.answerIndex,
          explanation: `Dynamic mapping from RxNav/RxNorm brand concepts.`,
          ref: "RxNav/RxNorm (dynamic)"
        });
      }
    }
  }
  return questions.slice(0, targetCount);
}

/* =========================
   Local question bank (expanded)
========================= */

function buildLocalBank(){
  const bank = [];
  const pushQ = (domain, stem, correct, wrong, exp, ref, id) => {
    const choices = shuffle([correct, ...wrong]);
    bank.push({ id, domain, stem, choices, answerIndex: choices.indexOf(correct), explanation: exp, ref });
  };

  let idc = 1;

  // ---------- MEDICATIONS (variety: brands, classes, indications, suffixes, interactions) ----------
  const M = DOMAIN.MEDS;

  const gb = [
    ["atorvastatin","Lipitor"],["rosuvastatin","Crestor"],["simvastatin","Zocor"],["pravastatin","Pravachol"],
    ["lisinopril","Prinivil/Zestril"],["losartan","Cozaar"],["valsartan","Diovan"],["amlodipine","Norvasc"],
    ["metformin","Glucophage"],["glipizide","Glucotrol"],["sitagliptin","Januvia"],
    ["levothyroxine","Synthroid"],["omeprazole","Prilosec"],["pantoprazole","Protonix"],
    ["sertraline","Zoloft"],["fluoxetine","Prozac"],["escitalopram","Lexapro"],
    ["bupropion","Wellbutrin"],["duloxetine","Cymbalta"],["venlafaxine","Effexor"],
    ["gabapentin","Neurontin"],["pregabalin","Lyrica"],
    ["albuterol","Ventolin/ProAir"],["fluticasone","Flonase"],["montelukast","Singulair"],
    ["tamsulosin","Flomax"],["finasteride","Proscar"],
    ["ondansetron","Zofran"],["famotidine","Pepcid"],
    ["cetirizine","Zyrtec"],["loratadine","Claritin"],
    ["valacyclovir","Valtrex"],["acyclovir","Zovirax"],
    ["clopidogrel","Plavix"],
  ];
  gb.forEach(([g,b])=>{
    pushQ(M, `Brand name for <b>${g}</b>:`, b, ["Lasix","Keflex","Xanax"], `${g} is commonly known by the brand ${b}.`, "Generic/Brand", `local:meds:gb:${idc++}`);
  });

  pushQ(M, "Which suffix suggests an <b>ACE inhibitor</b>?", "-pril", ["-sartan","-prazole","-olol"], "ACE inhibitors often end in -pril.", "Suffixes", `local:meds:suf:${idc++}`);
  pushQ(M, "Which suffix suggests an <b>ARB</b>?", "-sartan", ["-pril","-prazole","-azole"], "ARBs often end in -sartan.", "Suffixes", `local:meds:suf:${idc++}`);
  pushQ(M, "Which suffix suggests a <b>beta blocker</b>?", "-olol", ["-pril","-prazole","-statin"], "Many beta blockers end in -olol.", "Suffixes", `local:meds:suf:${idc++}`);
  pushQ(M, "Which suffix suggests a <b>statin</b>?", "-statin", ["-caine","-mab","-prazole"], "HMG-CoA reductase inhibitors end in -statin.", "Suffixes", `local:meds:suf:${idc++}`);
  pushQ(M, "Which suffix suggests a <b>PPI</b>?", "-prazole", ["-pril","-sartan","-cycline"], "Proton pump inhibitors often end in -prazole.", "Suffixes", `local:meds:suf:${idc++}`);
  pushQ(M, "Which medication is commonly used for <b>acute asthma relief</b>?", "Albuterol", ["Fluticasone","Montelukast","Cetirizine"], "Albuterol is a short-acting beta-agonist used for quick relief.", "Indications", `local:meds:ind:${idc++}`);
  pushQ(M, "A common adverse effect of <b>ACE inhibitors</b> is:", "Dry cough", ["Photosensitivity","Tooth discoloration","Ototoxicity"], "ACE inhibitors can cause cough (bradykinin effect).", "Side effects", `local:meds:se:${idc++}`);
  pushQ(M, "Which insulin type is typically <b>rapid-acting</b>?", "Insulin lispro", ["Insulin glargine","NPH insulin","Insulin detemir"], "Lispro/aspart are rapid; glargine/detemir long; NPH intermediate.", "Insulin types", `local:meds:ins:${idc++}`);
  pushQ(M, "Which is a <b>contraindication</b> concern with nitrates + PDE-5 inhibitors (e.g., sildenafil)?", "Severe hypotension", ["Hyperglycemia","Kidney stones","QT shortening"], "Nitrates + sildenafil can cause dangerous hypotension.", "Interactions", `local:meds:int:${idc++}`);
  pushQ(M, "Warfarin + which OTC most increases bleeding risk?", "NSAIDs (ibuprofen/naproxen)", ["Calcium carbonate","Saline spray","Artificial tears"], "NSAIDs increase bleeding risk with anticoagulants.", "Interactions", `local:meds:int:${idc++}`);
  pushQ(M, "A common indication for <b>tamsulosin</b> is:", "BPH urinary symptoms", ["Hyperthyroidism","Bacterial pneumonia","Gout flare"], "Tamsulosin is an alpha-1 blocker for BPH symptoms.", "Indications", `local:meds:ind:${idc++}`);
  pushQ(M, "Which antibiotic is a <b>macrolide</b>?", "Azithromycin", ["Cephalexin","Doxycycline","Amoxicillin"], "Azithromycin is a macrolide.", "Classes", `local:meds:cls:${idc++}`);
  pushQ(M, "Which is a <b>tetracycline</b> antibiotic?", "Doxycycline", ["Clindamycin","Cephalexin","Azithromycin"], "Doxycycline is a tetracycline.", "Classes", `local:meds:cls:${idc++}`);
  pushQ(M, "Which is a common indication for <b>metformin</b>?", "Type 2 diabetes", ["Migraine abortive","Atrial fibrillation","GERD"], "Metformin is first-line for type 2 diabetes.", "Indications", `local:meds:ind:${idc++}`);
  pushQ(M, "Which is a common counseling point for <b>doxycycline</b>?", "Avoid excessive sun exposure", ["Take only with grapefruit juice","Store frozen","Chew tablets for best effect"], "Doxycycline can cause photosensitivity.", "Counseling", `local:meds:coun:${idc++}`);
  pushQ(M, "Which medication is commonly used for <b>GERD</b>?", "Omeprazole", ["Albuterol","Acyclovir","Tamsulosin"], "PPIs treat GERD.", "Indications", `local:meds:ind:${idc++}`);
  pushQ(M, "Therapeutic duplication means:", "Two meds from the same class/with same effect used together unnecessarily", ["Two identical NDCs in stock","Two pharmacies fill same Rx","Two refills on one prescription"], "Duplication increases risk without benefit.", "Safety concept", `local:meds:dup:${idc++}`);
  pushQ(M, "Which is an <b>SSRI</b>?", "Sertraline", ["Duloxetine","Bupropion","Amitriptyline"], "Sertraline is an SSRI.", "Classes", `local:meds:cls:${idc++}`);
  pushQ(M, "Which medication is used for <b>nausea/vomiting</b>?", "Ondansetron", ["Atorvastatin","Losartan","Metformin"], "Ondansetron is an antiemetic.", "Indications", `local:meds:ind:${idc++}`);

  // ---------- SAFETY / QUALITY / USP / infection control ----------
  const S = DOMAIN.SAFETY;

  pushQ(S, "USP <795> covers:", "Non-sterile compounding", ["Sterile compounding","Controlled substance ordering","Insurance billing"], "USP 795: non-sterile compounding standards.", "USP", `local:safety:usp:${idc++}`);
  pushQ(S, "USP <797> covers:", "Sterile compounding", ["Non-sterile compounding","Look-alike/sound-alike rules","DEA forms"], "USP 797: sterile compounding standards.", "USP", `local:safety:usp:${idc++}`);
  pushQ(S, "USP <800> focuses on:", "Hazardous drug handling safety", ["Sterile technique only","DSCSA requirements","PBM claims"], "USP 800: hazardous drug handling to reduce exposure.", "USP", `local:safety:usp:${idc++}`);

  pushQ(S, "Best practice for a <b>leading zero</b> is:", "Write 0.5 mg (not .5 mg)", ["Write .5 mg only","Write 00.5 mg","Never use decimals"], "Leading zeros reduce tenfold errors.", "Error prevention", `local:safety:err:${idc++}`);
  pushQ(S, "Best practice for a <b>trailing zero</b> is:", "Avoid 5.0 mg; write 5 mg", ["Always write 5.0 mg","Write 5.00 mg for clarity","Use commas instead"], "Trailing zeros can cause tenfold errors.", "Error prevention", `local:safety:err:${idc++}`);

  pushQ(S, "A high-alert medication example is:", "Insulin", ["Acetaminophen","Docusate","Loratadine"], "Insulin is commonly classified high-alert due to harm potential.", "High-alert", `local:safety:ha:${idc++}`);
  pushQ(S, "LASA stands for:", "Look-alike/sound-alike", ["Label-all/store-all","Long-acting/short-acting","Lot-and-serial-audit"], "LASA meds are a major error source.", "Terminology", `local:safety:lasa:${idc++}`);

  pushQ(S, "Sterile compounding: best garbing order (simplified):", "Hand hygiene → gown → mask → gloves",
    ["Gloves → gown → mask → hands","Mask → gloves → gown → hands","Gown → gloves → hands → mask"],
    "Hand hygiene first; then garb to reduce contamination.", "Sterile technique", `local:safety:garb:${idc++}`);

  pushQ(S, "A situation requiring pharmacist intervention is:", "Potential serious drug interaction", ["Patient requests water","Printer out of paper","Counting tray needs cleaning"], "Interactions/DUR issues require pharmacist review.", "Workflow safety", `local:safety:pharm:${idc++}`);
  pushQ(S, "MedWatch is primarily used to report:", "Serious adverse events/product issues to FDA", ["Lost controlled substances to DEA","Insurance fraud to PBM","HIPAA violations to OCR"], "MedWatch is FDA’s safety reporting program.", "Reporting", `local:safety:report:${idc++}`);

  // ---------- ORDER ENTRY / PROCESSING / MATH / INSURANCE ----------
  const O = DOMAIN.ORDER;

  // Conversions
  pushQ(O, "How many <b>mcg</b> are in <b>1 mg</b>?", "1000 mcg", ["100 mcg","10 mcg","10,000 mcg"], "1 mg = 1000 mcg.", "Conversions", `local:order:conv:${idc++}`);
  pushQ(O, "How many <b>mg</b> are in <b>1 g</b>?", "1000 mg", ["100 mg","10 mg","10,000 mg"], "1 g = 1000 mg.", "Conversions", `local:order:conv:${idc++}`);
  pushQ(O, "Convert <b>2.5 g</b> to mg:", "2500 mg", ["250 mg","25,000 mg","2,500,000 mg"], "Multiply grams by 1000.", "Conversions", `local:order:conv:${idc++}`);
  pushQ(O, "Convert 220 lb to kg (rounded).", "100 kg", ["90 kg","110 kg","75 kg"], "kg = lb ÷ 2.2; 220 ÷ 2.2 = 100.", "Conversions", `local:order:conv:${idc++}`);
  pushQ(O, "Convert <b>5 mL</b> to teaspoons (tsp).", "1 tsp", ["0.5 tsp","2 tsp","3 tsp"], "1 tsp = 5 mL.", "Conversions", `local:order:conv:${idc++}`);

  // Multi-step scenarios
  pushQ(O,
    "Scenario: Child weighs <b>44 lb</b>. Rx: <b>amoxicillin 20 mg/kg/day</b> divided <b>BID</b>. What is <b>mg per dose</b>?",
    "200 mg per dose",
    ["400 mg per dose","100 mg per dose","20 mg per dose"],
    "44 lb = 20 kg. Daily dose = 20×20 = 400 mg/day. BID → 200 mg/dose.",
    "Multi-step dosing", `local:order:ms:${idc++}`
  );

  pushQ(O,
    "IV infusion: <b>1000 mL over 8 hours</b>. Rate in <b>mL/hr</b>?",
    "125 mL/hr",
    ["80 mL/hr","100 mL/hr","150 mL/hr"],
    "1000 ÷ 8 = 125 mL/hr.",
    "IV calculations", `local:order:iv:${idc++}`
  );

  pushQ(O,
    "Scenario: Rx says <b>Take 1 tab PO QID x 10 days</b>. Quantity needed?",
    "40 tablets",
    ["10 tablets","30 tablets","60 tablets"],
    "QID = 4/day. 4×10 = 40.",
    "Days supply/quantity", `local:order:ds:${idc++}`
  );

  pushQ(O,
    "Alligation is most commonly used to calculate:",
    "Mixtures of different strengths to reach a target strength",
    ["Days supply for inhalers","NDC selection","DEA schedule"],
    "Alligation helps find parts of each strength to mix.",
    "Calculations", `local:order:all:${idc++}`
  );

  // Workflow / insurance
  pushQ(O,
    "Insurance reject: <b>Refill too soon</b>. Best first step?",
    "Verify last fill date, day supply, and data entry accuracy",
    ["Override immediately","Dispense without billing","Change drug without prescriber"],
    "Start by verifying timing and entry; then follow plan policy.",
    "Insurance workflow", `local:order:ins:${idc++}`
  );

  pushQ(O,
    "A prior authorization (PA) is typically required when:",
    "Plan needs clinical justification before coverage",
    ["Patient wants cash price","NDC is missing","Label printer is down"],
    "PA = prescriber/plan clinical approval process.",
    "Insurance workflow", `local:order:ins:${idc++}`
  );

  pushQ(O,
    "A DAW code generally relates to:",
    "Dispense As Written / substitution instructions",
    ["Drug assay weight","Dose after withdrawal","DEA audit window"],
    "DAW codes indicate substitution permissions/requirements.",
    "Order entry", `local:order:daw:${idc++}`
  );

  // Compounding (non-sterile basics)
  pushQ(O, "A common purpose of a <b>levigating agent</b> is to:", "Help form a smooth paste when triturating powders",
    ["Increase pH rapidly","Sterilize a product","Increase controlled substance security"],
    "Levigating agents help incorporate powders into bases smoothly.", "Compounding", `local:order:comp:${idc++}`);

  pushQ(O, "Which is a common non-sterile dosage form?", "Ointment", ["IV admixture","TPN bag","Sterile syringe prep"], "Ointments are non-sterile compounds in many settings.", "Compounding", `local:order:comp:${idc++}`);

  // ---------- FEDERAL (DEA forms, controlled substances, DSCSA/serialization, retention) ----------
  const F = DOMAIN.FED;

  pushQ(F, "DEA Form used to order Schedule II controlled substances:", "DEA Form 222",
    ["DEA Form 106","DEA Form 41","DEA Form 224"],
    "DEA 222 is used for ordering Schedule II controlled substances.",
    "DEA forms", `local:fed:dea:${idc++}`
  );

  pushQ(F, "DEA Form used to report theft/significant loss of controlled substances:", "DEA Form 106",
    ["DEA Form 222","DEA Form 41","DEA Form 224"],
    "DEA 106 is used for theft/loss reporting.",
    "DEA forms", `local:fed:dea:${idc++}`
  );

  pushQ(F, "DEA Form commonly used to document controlled substance destruction:", "DEA Form 41",
    ["DEA Form 106","DEA Form 222","DEA Form 363"],
    "DEA Form 41 documents controlled substance destruction (where applicable).",
    "DEA forms", `local:fed:dea:${idc++}`
  );

  pushQ(F, "A DEA registration application for many registrants is:", "DEA Form 224",
    ["DEA Form 222","DEA Form 106","DEA Form 41"],
    "DEA 224 is a common registration form number referenced in training contexts.",
    "DEA forms", `local:fed:dea:${idc++}`
  );

  pushQ(F, "Schedule II prescriptions federally:", "Cannot be refilled",
    ["Up to 5 refills in 6 months","Unlimited refills","Refill allowed if pharmacist approves"],
    "CII cannot be refilled under federal law.",
    "Controlled substance rules", `local:fed:c:${idc++}`
  );

  pushQ(F, "Schedule III–V refills federally (typical rule):", "Up to 5 refills within 6 months",
    ["No refills allowed","Unlimited refills","Exactly 2 refills"],
    "CIII–V commonly: 5 refills/6 months (subject to state/plan).",
    "Controlled substance rules", `local:fed:c:${idc++}`
  );

  pushQ(F, "Federal controlled substance record retention minimum is commonly:", "2 years",
    ["6 months","1 year","10 years"],
    "Federal baseline is commonly 2 years (state may require longer).",
    "Record retention", `local:fed:rr:${idc++}`
  );

  pushQ(F, "DSCSA primarily relates to:", "Drug supply chain security (serialization/traceability)",
    ["Patient privacy only","DEA scheduling only","Insurance billing rules only"],
    "DSCSA focuses on tracing/verification and supply chain integrity.",
    "FDA/DSCSA", `local:fed:dscsa:${idc++}`
  );

  pushQ(F, "Pseudoephedrine sales controls are most associated with:", "Combat Methamphetamine Epidemic Act (CMEA)-type restrictions",
    ["HIPAA only","CLIA only","REMS only"],
    "Pseudoephedrine is regulated due to diversion concerns.",
    "Restricted products", `local:fed:pse:${idc++}`
  );

  pushQ(F, "HIPAA primarily protects:", "Patient health information privacy",
    ["Drug pricing rules","Controlled substance ordering","NDC formatting"],
    "HIPAA regulates privacy/security of PHI.",
    "Privacy", `local:fed:hipaa:${idc++}`
  );

  // Make sure each domain has enough candidates; repeats are allowed if needed.
  return bank;
}

/* =========================
   Assembly helpers
========================= */

function partitionByDomain(items){
  const map = new Map();
  items.forEach(it=>{
    if(!map.has(it.domain)) map.set(it.domain, []);
    map.get(it.domain).push(it);
  });
  return map;
}

function pickFromDomain(domain, need, candidates, learningMode){
  if(need <= 0) return [];
  const stats = loadStats();
  const picked = learningMode
    ? weightedSampleNoReplace(candidates, need, (q)=>weightForPick(q.id, stats))
    : randomSampleNoReplace(candidates, need);

  // backfill with repeats if needed
  if(picked.length < need && candidates.length > 0){
    while(picked.length < need){
      picked.push(candidates[Math.floor(Math.random()*candidates.length)]);
    }
  }
  return picked.slice(0, need);
}

function applyChoiceShuffle(finalQs){
  finalQs.forEach(item=>{
    const correctText = item.choices[item.answerIndex];
    shuffle(item.choices);
    item.answerIndex = item.choices.indexOf(correctText);
  });
}

function ensureExactly90(finalQs){
  const allLocal = buildLocalBank();
  const existing = new Set(finalQs.map(q => q.id));
  let safetyCounter = 0;

  while(finalQs.length < TOTAL_QUESTIONS && safetyCounter < 10000){
    safetyCounter++;
    const candidate = allLocal[Math.floor(Math.random()*allLocal.length)];
    if(!existing.has(candidate.id) || finalQs.length > TOTAL_QUESTIONS - 6){
      finalQs.push(candidate);
      existing.add(candidate.id);
    }
  }
  return finalQs.slice(0, TOTAL_QUESTIONS);
}

/* =========================
   UI State
========================= */

let state = {
  questions: [],
  index: 0,
  answers: new Map(),
  flagged: new Set(),
  timed: false,
  timeLeftSec: 110*60,
  timerHandle: null,
  shuffleQ: true,
  shuffleA: true,
  useOnlineMeds: true,
  learningMode: true,
  isBuilt: false
};

/* =========================
   Elements
========================= */

const startScreen = document.getElementById("startScreen");
const examScreen = document.getElementById("examScreen");
const resultsScreen = document.getElementById("resultsScreen");

const startBtn = document.getElementById("startBtn");
const resetBtn = document.getElementById("resetBtn");
const wipeStatsBtn = document.getElementById("wipeStatsBtn");

const shuffleQEl = document.getElementById("shuffleQ");
const shuffleAEl = document.getElementById("shuffleA");
const timedEl = document.getElementById("timed");
const timerLenEl = document.getElementById("timerLen");
const useOnlineMedsEl = document.getElementById("useOnlineMeds");
const learningModeEl = document.getElementById("learningMode");
const statusBox = document.getElementById("statusBox");

const qCounter = document.getElementById("qCounter");
const totalQEl = document.getElementById("totalQ");
const answeredCount = document.getElementById("answeredCount");
const flagCount = document.getElementById("flagCount");
const progressBar = document.getElementById("progressBar");

const qTitle = document.getElementById("qTitle");
const qMeta = document.getElementById("qMeta");
const qStem = document.getElementById("qStem");
const choicesEl = document.getElementById("choices");
const domainTag = document.getElementById("domainTag");

const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const flagBtn = document.getElementById("flagBtn");
const clearBtn = document.getElementById("clearBtn");
const submitBtn = document.getElementById("submitBtn");
const endBtn = document.getElementById("endBtn");
const navGrid = document.getElementById("navGrid");

const timerPill = document.getElementById("timerPill");
const timeLeftEl = document.getElementById("timeLeft");

const overallScoreEl = document.getElementById("overallScore");
const correctCountEl = document.getElementById("correctCount");
const incorrectCountEl = document.getElementById("incorrectCount");
const unansweredCountEl = document.getElementById("unansweredCount");
const domainBreakdownEl = document.getElementById("domainBreakdown");
const reviewList = document.getElementById("reviewList");

const restartBtn = document.getElementById("restartBtn");
const backHomeBtn = document.getElementById("backHomeBtn");

/* =========================
   Timer
========================= */

function stopTimer(){
  if(state.timerHandle){
    clearInterval(state.timerHandle);
    state.timerHandle = null;
  }
}
function startTimer(){
  stopTimer();
  timeLeftEl.textContent = fmtTime(state.timeLeftSec);
  state.timerHandle = setInterval(() => {
    state.timeLeftSec -= 1;
    timeLeftEl.textContent = fmtTime(Math.max(0, state.timeLeftSec));
    if(state.timeLeftSec <= 0){
      stopTimer();
      submitExam(true);
    }
  }, 1000);
}

/* =========================
   Reset / navigation
========================= */

function hardReset(){
  state.questions = [];
  state.index = 0;
  state.answers = new Map();
  state.flagged = new Set();
  state.timed = timedEl.checked;

  const mins = parseInt(timerLenEl.value, 10) || 110;
  state.timeLeftSec = mins * 60;

  state.shuffleQ = shuffleQEl.checked;
  state.shuffleA = shuffleAEl.checked;
  state.useOnlineMeds = useOnlineMedsEl.checked;
  state.learningMode = learningModeEl.checked;
  state.isBuilt = false;

  stopTimer();
  statusBox.style.display = "none";
  startScreen.style.display = "";
  examScreen.style.display = "none";
  resultsScreen.style.display = "none";

  submitBtn.disabled = true; // only until built
  startBtn.disabled = false;
}

resetBtn.addEventListener("click", hardReset);
wipeStatsBtn.addEventListener("click", () => {
  wipeStats();
  statusBox.className = "ok tiny";
  statusBox.style.display = "";
  statusBox.textContent = "Learning history cleared on this device.";
});
endBtn.addEventListener("click", () => hardReset());
restartBtn.addEventListener("click", () => buildExam());
backHomeBtn.addEventListener("click", () => hardReset());

/* =========================
   Build exam (atomic)
========================= */

async function buildExam(){
  startBtn.disabled = true;
  submitBtn.disabled = true; // disabled only during build

  state.shuffleQ = shuffleQEl.checked;
  state.shuffleA = shuffleAEl.checked;
  state.timed = timedEl.checked;
  state.useOnlineMeds = useOnlineMedsEl.checked;
  state.learningMode = learningModeEl.checked;

  const mins = parseInt(timerLenEl.value, 10) || 110;
  state.timeLeftSec = mins * 60;

  statusBox.style.display = "none";

  const local = buildLocalBank();
  const byDomainLocal = partitionByDomain(local);

  // Medications domain: allow some dynamic meds but keep local variety too.
  const medsTarget = COUNTS[DOMAIN.MEDS];
  let dynamicMeds = [];

  if(state.useOnlineMeds){
    statusBox.className = "warnbox tiny";
    statusBox.style.display = "";
    statusBox.textContent = "Fetching fresh medication questions from RxNav… (If it fails, we backfill locally.)";
    try{
      dynamicMeds = await buildDynamicMedsQuestions(medsTarget);
      statusBox.className = "ok tiny";
      statusBox.textContent = `Loaded ${dynamicMeds.length} RxNav medication questions. Building your exam…`;
    } catch(e){
      statusBox.className = "warnbox tiny";
      statusBox.textContent = "RxNav fetch failed (offline/rate-limited). Using local meds only.";
      dynamicMeds = [];
    }
  }

  const final = [];

  // Meds
  const medsFromDynamic = dynamicMeds.slice(0, medsTarget);
  const medsRemaining = medsTarget - medsFromDynamic.length;
  final.push(...medsFromDynamic, ...pickFromDomain(DOMAIN.MEDS, medsRemaining, byDomainLocal.get(DOMAIN.MEDS)||[], state.learningMode));

  // Other domains
  final.push(...pickFromDomain(DOMAIN.FED, COUNTS[DOMAIN.FED], byDomainLocal.get(DOMAIN.FED)||[], state.learningMode));
  final.push(...pickFromDomain(DOMAIN.SAFETY, COUNTS[DOMAIN.SAFETY], byDomainLocal.get(DOMAIN.SAFETY)||[], state.learningMode));
  final.push(...pickFromDomain(DOMAIN.ORDER, COUNTS[DOMAIN.ORDER], byDomainLocal.get(DOMAIN.ORDER)||[], state.learningMode));

  let assembled = ensureExactly90(final);

  if(state.shuffleA) applyChoiceShuffle(assembled);
  if(state.shuffleQ) shuffle(assembled);

  assembled = ensureExactly90(assembled).slice(0, TOTAL_QUESTIONS);

  state.questions = assembled;
  state.index = 0;
  state.answers = new Map();
  state.flagged = new Set();
  state.isBuilt = (state.questions.length === TOTAL_QUESTIONS);

  // Reveal exam UI
  startScreen.style.display = "none";
  resultsScreen.style.display = "none";
  examScreen.style.display = "";

  timerPill.style.display = state.timed ? "" : "none";
  totalQEl.textContent = String(TOTAL_QUESTIONS);

  if(state.timed){
    timeLeftEl.textContent = fmtTime(state.timeLeftSec);
    startTimer();
  } else {
    stopTimer();
  }

  renderNav();
  renderQuestion();
  renderTopStats();

  // Submit is enabled immediately after build, regardless of unanswered count.
  submitBtn.disabled = false;
}

startBtn.addEventListener("click", buildExam);

/* =========================
   Render
========================= */

function renderTopStats(){
  const answered = state.answers.size;
  const flagged = state.flagged.size;
  qCounter.textContent = String(state.index + 1);
  answeredCount.textContent = String(answered);
  flagCount.textContent = String(flagged);
  progressBar.style.width = `${Math.round((answered / TOTAL_QUESTIONS) * 100)}%`;
}

function renderQuestion(){
  const item = state.questions[state.index];
  qTitle.textContent = `Question ${state.index + 1}`;
  qMeta.textContent = `Reference focus: ${item.ref}`;
  domainTag.textContent = item.domain;

  qStem.innerHTML = item.stem;
  choicesEl.innerHTML = "";

  const selected = state.answers.get(item.id);

  item.choices.forEach((c, idx) => {
    const lab = document.createElement("label");
    lab.className = "choice" + (selected === idx ? " selected" : "");
    const inp = document.createElement("input");
    inp.type = "radio";
    inp.name = "choice";
    inp.value = String(idx);
    if(selected === idx) inp.checked = true;

    inp.addEventListener("change", () => {
      state.answers.set(item.id, idx);
      renderTopStats();
      renderNav();
      renderQuestion(); // refresh selected styling
    });

    const span = document.createElement("div");
    span.innerHTML = `<b>${String.fromCharCode(65 + idx)}.</b> ${c}`;
    lab.appendChild(inp);
    lab.appendChild(span);
    choicesEl.appendChild(lab);
  });

  prevBtn.disabled = state.index === 0;
  nextBtn.disabled = state.index === state.questions.length - 1;

  flagBtn.textContent = state.flagged.has(item.id) ? "Unflag" : "Flag";

  renderTopStats();
  renderNav();
}

function renderNav(){
  navGrid.innerHTML = "";
  state.questions.forEach((it, i) => {
    const b = document.createElement("button");
    b.className = "navbtn";
    b.textContent = String(i + 1);

    if(state.answers.has(it.id)) b.classList.add("answered");
    if(state.flagged.has(it.id)) b.classList.add("flagged");
    if(i === state.index) b.classList.add("current");

    b.addEventListener("click", () => {
      state.index = i;
      renderQuestion();
    });
    navGrid.appendChild(b);
  });
}

/* =========================
   Controls
========================= */

prevBtn.addEventListener("click", () => { if(state.index>0){ state.index--; renderQuestion(); } });
nextBtn.addEventListener("click", () => { if(state.index<state.questions.length-1){ state.index++; renderQuestion(); } });

flagBtn.addEventListener("click", () => {
  const id = state.questions[state.index].id;
  if(state.flagged.has(id)) state.flagged.delete(id);
  else state.flagged.add(id);
  renderQuestion();
});

clearBtn.addEventListener("click", () => {
  const id = state.questions[state.index].id;
  state.answers.delete(id);
  renderQuestion();
});

submitBtn.addEventListener("click", () => submitExam(false));

window.addEventListener("keydown", (e) => {
  if(examScreen.style.display === "none") return;
  if(e.key === "ArrowLeft") prevBtn.click();
  if(e.key === "ArrowRight") nextBtn.click();
});

/* =========================
   Scoring + learning update
========================= */

function updateLearningStats(qid, wasCorrect){
  const stats = loadStats();
  const s = stats[qid] || { attempts:0, correct:0, lastSeen:0 };
  s.attempts = (s.attempts || 0) + 1;
  if(wasCorrect) s.correct = (s.correct || 0) + 1;
  s.lastSeen = nowTs();
  stats[qid] = s;
  saveStats(stats);
}

function submitExam(fromTimer){
  stopTimer();

  // Hard lock scoring base to 90 questions always.
  const qs = (state.questions && state.questions.length === TOTAL_QUESTIONS)
    ? state.questions
    : ensureExactly90(state.questions || []);

  let correct = 0;
  let incorrect = 0;
  let unanswered = 0;

  const byDomain = new Map();
  qs.forEach(it => {
    if(!byDomain.has(it.domain)) byDomain.set(it.domain, {correct:0, total:0});
    byDomain.get(it.domain).total += 1;

    const ans = state.answers.get(it.id);
    if(ans === undefined){ unanswered++; return; }

    const ok = ans === it.answerIndex;
    if(ok){ correct++; byDomain.get(it.domain).correct += 1; }
    else { incorrect++; }
    updateLearningStats(it.id, ok);
  });

  const overallPct = Math.round((correct / TOTAL_QUESTIONS) * 100);

  overallScoreEl.textContent = `${overallPct}%`;
  correctCountEl.textContent = String(correct);
  incorrectCountEl.textContent = String(incorrect);
  unansweredCountEl.textContent = String(unanswered);

  domainBreakdownEl.innerHTML = "";
  [...byDomain.entries()].forEach(([domain, stats]) => {
    const pct = stats.total ? Math.round((stats.correct / stats.total) * 100) : 0;
    const pill = document.createElement("div");
    pill.className = "pill";
    pill.innerHTML = `${domain}: <b>${stats.correct}/${stats.total}</b> (${pct}%)`;
    domainBreakdownEl.appendChild(pill);
  });

  reviewList.innerHTML = "";
  qs.forEach((it, i) => {
    const userAns = state.answers.get(it.id);
    const isCorrect = userAns === it.answerIndex;
    const status = (userAns === undefined) ? "Unanswered" : (isCorrect ? "Correct" : "Incorrect");

    const div = document.createElement("div");
    div.className = "reviewItem";

    const userText = (userAns === undefined) ? "<i>—</i>" : `${String.fromCharCode(65+userAns)}. ${it.choices[userAns]}`;
    const correctText = `${String.fromCharCode(65+it.answerIndex)}. ${it.choices[it.answerIndex]}`;

    div.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div><b>Q${i+1}</b> <span class="muted tiny">(${it.domain})</span></div>
        <div class="${status==='Correct' ? 'correct' : (status==='Incorrect' ? 'incorrect' : 'muted')}">${status}</div>
      </div>
      <div class="stem" style="margin-top:8px">${it.stem}</div>
      <div class="tiny"><b>Your answer:</b> ${userText}</div>
      <div class="tiny"><b>Correct answer:</b> ${correctText}</div>
      <div class="explain tiny"><b>Why:</b> ${it.explanation}</div>
      <div class="tiny muted" style="margin-top:6px"><b>Question ID:</b> ${it.id}</div>
    `;
    reviewList.appendChild(div);
  });

  examScreen.style.display = "none";
  resultsScreen.style.display = "";
  startScreen.style.display = "none";

  window.scrollTo({top:0, behavior:"smooth"});
  if(fromTimer) alert("Time is up. Your exam has been submitted.");
}

// Boot
hardReset();
</script>
</body>
</html>
